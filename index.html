<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>رواق العدل — واجهة احترافية للمداخل</title>

  <!-- خطوط وأيقونات -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <meta name="description" content="واجهة احترافية بمداخل محسنة وUX متقدم لمنصة المساعد الذكي وإدارة القضايا — رواق العدل" />
  <meta name="author" content="روان الصبحي" />

  <style>
    /* ================= Design tokens ================= */
    :root{
      --bg-1:#022f2e; --bg-2:#063733;
      --panel: rgba(255,255,255,0.03);
      --muted:#9fbfb0;
      --accent:#0fb06b;
      --gold:#FFB703;
      --glass: rgba(255,255,255,0.02);
      --radius:12px;
      --shadow: 0 14px 48px rgba(0,0,0,0.6);
      --maxw:1240px;
      --gap:14px;
      --ui-ease: cubic-bezier(.2,.9,.2,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Cairo',sans-serif;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#eaffef;-webkit-font-smoothing:antialiased}
    a{color:var(--accent);text-decoration:none}

    /* =============== Layout =============== */
    .app{max-width:var(--maxw);margin:22px auto;padding:18px;display:grid;grid-template-columns:320px 1fr;gap:22px;align-items:start}
    @media (max-width:1000px){ .app{grid-template-columns:1fr;padding:12px} }

    /* background canvas (subtle) */
    #bgCanvas{position:fixed;inset:0;z-index:-3}
    .bg-overlay{position:fixed;inset:0;z-index:-2;background:
      radial-gradient(800px 260px at 8% 12%, rgba(180,240,210,0.04), transparent 8%),
      linear-gradient(180deg, rgba(0,0,0,0.16), rgba(0,0,0,0.34));mix-blend-mode:multiply;pointer-events:none}

    /* =============== Sidebar =============== */
    .sidebar{background:var(--panel);border-radius:var(--radius);padding:16px;border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#0b7d56);display:flex;align-items:center;justify-content:center}
    .brand h1{margin:0;font-size:18px}
    .brand p{margin:0;color:var(--muted);font-size:13px}

    nav.menu{margin-top:14px;display:flex;flex-direction:column;gap:8px}
    .menu button{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border:0;background:transparent;color:var(--muted);cursor:pointer}
    .menu button.active{background:linear-gradient(90deg, rgba(15,176,107,0.06), rgba(255,255,255,0.02));border-left:4px solid var(--gold);color:#fff}

    .assistant-list{margin-top:12px;border-radius:10px;overflow:auto;max-height:300px;padding:6px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02)}
    .assistant-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px}
    .assistant-item + .assistant-item{margin-top:8px}
    .assistant-item .meta{color:var(--muted);font-size:13px}

    /* =============== Main =============== */
    .main{display:flex;flex-direction:column;gap:16px}
    .card{border-radius:12px;padding:16px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow)}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .search{flex:1;display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .search input{border:0;background:transparent;outline:none;color:#eaffef;width:100%}

    /* =============== Inputs: professional styles =============== */
    .field { margin-top:12px; display:flex;flex-direction:column; gap:6px; }
    .float-label { position:relative; }
    .float-label input, .float-label textarea, .float-label select {
      width:100%; padding:14px 12px 10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.12); color:#eaffef; font-size:15px;
      transition: box-shadow .18s var(--ui-ease), border-color .18s var(--ui-ease);
    }
    .float-label textarea { min-height:120px; resize:vertical; padding-top:18px; }
    .float-label label {
      position:absolute; left:14px; top:12px; pointer-events:none; color:var(--muted); font-size:13px; transition: transform .15s var(--ui-ease), font-size .15s var(--ui-ease), top .15s var(--ui-ease);
      transform-origin:right top;
    }
    .float-label input:focus + label,
    .float-label select:focus + label,
    .float-label textarea:focus + label,
    .float-label input:not(:placeholder-shown) + label,
    .float-label textarea:not(:placeholder-shown) + label {
      transform: translateY(-10px) scale(.88);
      top:6px; font-size:12px; color:#fff;
    }
    input:focus, textarea:focus, select:focus { box-shadow: 0 8px 30px rgba(11,120,85,0.06); border-color: rgba(15,176,107,0.18); }

    .inline-hint{font-size:12px;color:var(--muted)}

    /* nicer selects */
    .select-search { position:relative; }
    .select-search input { padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.12);color:#eaffef }
    .select-dropdown { position:absolute; left:0; right:0; top:40px; background:rgba(0,0,0,0.14); border:1px solid rgba(255,255,255,0.03); border-radius:8px; max-height:180px; overflow:auto; z-index:80; padding:6px; }
    .select-dropdown div { padding:8px;border-radius:8px; cursor:pointer; color:#eaffef }
    .select-dropdown div:hover { background:rgba(255,255,255,0.03) }

    /* file list */
    .file-list { margin-top:8px; display:flex;flex-direction:column; gap:8px }
    .file-item { display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03) }
    .file-item .meta { color:var(--muted); font-size:13px }

    /* actions */
    .actions { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap }
    .actions .btn { min-width:clamp(84px,20vw,120px) }

    /* drawer */
    .drawer { position:fixed; top:70px; right:20px; width:420px; max-width:calc(100% - 40px); height:calc(100% - 120px); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:16px; box-shadow:0 30px 80px rgba(0,0,0,0.75); z-index:1400; overflow:auto; transform: translateY(8px); opacity:0; pointer-events:none; transition:all .22s var(--ui-ease)}
    .drawer.show { transform: translateY(0); opacity:1; pointer-events:auto }

    /* validation */
    .err{ color:#ffb3b3; font-size:13px; margin-top:6px }

    /* responsive tweaks */
    @media (max-width:520px){
      .drawer{ right:10px; width:calc(100% - 20px); top:90px; height:calc(100% - 160px) }
    }
  </style>
</head>
<body>
  <canvas id="bgCanvas" aria-hidden="true"></canvas>
  <div class="bg-overlay" aria-hidden="true"></div>

  <div class="app" role="application" aria-label="رواق العدل — الواجهة المحترفة">
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="الشريط الجانبي">
      <div class="brand" role="img" aria-label="رواق العدل">
        <div class="logo"><i class="fa-solid fa-balance-scale" style="color:#fff;font-size:20px"></i></div>
        <div>
          <h1>رواق العدل</h1>
          <p class="muted">مركز القضايا والمساعد</p>
        </div>
      </div>

      <nav class="menu" aria-label="التنقل">
        <button class="active" data-panel="panel-assistant"><i class="fa-solid fa-brain"></i> المساعد الذكي</button>
        <button data-panel="panel-casefile"><i class="fa-solid fa-file-circle-plus"></i> قيد دعوى</button>
        <button data-panel="panel-judgeboard"><i class="fa-solid fa-gavel"></i> منصة القاضي</button>
        <button data-panel="panel-memo"><i class="fa-solid fa-file-lines"></i> تبادل مذكرات</button>
      </nav>

      <div style="margin-top:16px">
        <strong>قائمة المساعدين</strong>
        <div class="assistant-list" id="assistantList" tabindex="0" aria-label="قائمة المساعدين"></div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="addAssistant" class="mini">+ جديد</button>
          <button id="manageAssistants" class="mini">إدارة</button>
        </div>
      </div>

      <div style="margin-top:18px;text-align:center" class="muted">licensing@rawan.dev</div>
    </aside>

    <!-- MAIN -->
    <main class="main" id="mainContent">
      <div class="topbar card" role="region" aria-label="شريط الأدوات">
        <div class="search" role="search">
          <i class="fa-solid fa-magnifying-glass" style="color:var(--muted)"></i>
          <input id="unifiedSearch" placeholder="بحث: رقم قضية، اسم، قرار..." aria-label="بحث" />
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="themeToggle" class="mini" title="تبديل السمة">سمة</button>
          <button id="openJudgeDrawer" class="mini" title="فتح تجربة قضية">قاضي — تجربة</button>
        </div>
      </div>

      <!-- Assistant panel -->
      <section id="panel-assistant" class="card" role="region" aria-labelledby="assistantTitle">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 id="assistantTitle">المساعد الذكي المحترف</h2>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="select-search" style="min-width:200px">
              <input id="assistantSearch" placeholder="بحث شخصيات..." aria-label="بحث شخصية" />
              <div id="assistantDropdown" class="select-dropdown" style="display:none"></div>
            </div>
            <select id="assistantSelect" aria-label="اختيار شخصية" style="min-width:220px"></select>
          </div>
        </div>

        <div style="display:flex;gap:16px;margin-top:14px">
          <div style="flex:1">
            <div class="field float-label">
              <input id="facts" placeholder=" " aria-label="ملخص الوقائع" />
              <label for="facts">ملخص الوقائع / المستند</label>
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
              <div class="modes" role="tablist" aria-label="أنماط">
                <button class="mode-btn active" data-mode="concise">مختصر</button>
                <button class="mode-btn" data-mode="detailed">مفصّل</button>
                <button class="mode-btn" data-mode="step">خطوات</button>
              </div>
              <div class="inline-hint">Ctrl/Cmd + Enter للتشغيل</div>
            </div>

            <div class="progress" id="progressBar" aria-hidden="true" style="display:none"><i></i></div>
          </div>

          <div style="width:260px;display:flex;flex-direction:column;gap:10px">
            <button id="runBtn" class="btn" aria-live="polite"><i class="fa-solid fa-rocket"></i> تشغيل التحليل</button>
            <button id="streamToggle" class="btn ghost">بث لحظي</button>
            <button id="saveDraftBtn" class="btn ghost">حفظ مسودة</button>
            <div style="display:flex;gap:8px">
              <button id="exportTxt" class="mini">تصدير</button>
              <button id="printBtn" class="mini">طباعة</button>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:14px;margin-top:16px;align-items:flex-start">
          <div style="flex:1">
            <h3>نتيجة التحليل</h3>
            <pre id="analysisResult" class="result" aria-live="polite">لم يتم تشغيل أي تحليل بعد.</pre>
          </div>

          <aside style="width:320px">
            <div class="card">
              <h4>تفاصيل الشخصية</h4>
              <div id="assistantDetails" class="muted-sm" style="margin-top:8px">اختر شخصية لعرض التفاصيل النظامية.</div>
            </div>

            <div class="card" style="margin-top:12px">
              <h4>سجل التحليلات</h4>
              <div id="historyList" style="max-height:260px;overflow:auto"></div>
            </div>
          </aside>
        </div>
      </section>

      <!-- Case filing: professional inputs -->
      <section id="panel-casefile" class="card" role="region" hidden>
        <h2 style="margin-top:0">قيد دعوى — نموذج متقدّم</h2>
        <p class="muted">نموذج احترافي مع تحقُّق ورفع مرفقات ومعاينة قبل الإرسال.</p>

        <form id="caseForm" class="form-grid" onsubmit="return false" novalidate>
          <div>
            <div style="display:flex;gap:12px">
              <div style="flex:1" class="float-label">
                <input id="case_id" placeholder=" " />
                <label for="case_id">رقم القضية (اختياري)</label>
              </div>
              <div style="width:180px" class="float-label">
                <input id="case_internal" placeholder=" " />
                <label for="case_internal">الرقم الداخلي</label>
              </div>
            </div>

            <div class="field float-label">
              <input id="case_plaintiff" placeholder=" " required />
              <label for="case_plaintiff">اسم المدعي</label>
              <div id="err_plaintiff" class="err" style="display:none"></div>
            </div>

            <div class="field float-label">
              <input id="case_subject" placeholder=" " required />
              <label for="case_subject">موضوع الدعوى</label>
              <div id="err_subject" class="err" style="display:none"></div>
            </div>

            <div class="field float-label">
              <textarea id="case_details" placeholder=" " required></textarea>
              <label for="case_details">تفاصيل / ملخص</label>
            </div>

            <div style="display:flex;gap:8px;align-items:flex-start;margin-top:10px">
              <div style="flex:1">
                <label>مرفقات</label>
                <div id="caseUploader" class="file-drop" tabindex="0" aria-label="مساحة رفع الملفات">اسحب الملفات هنا أو اضغط للاختيار</div>
                <div id="fileList" class="file-list" aria-live="polite"></div>
                <div id="caseUploadProgress" class="progress" style="display:none"><i></i></div>
              </div>

              <div style="width:160px">
                <label>&nbsp;</label>
                <button id="submitCase" class="btn" type="button">قيد الدعوى</button>
              </div>
            </div>

            <div id="caseFeedback" class="muted-sm" style="margin-top:10px;display:none"></div>
          </div>

          <aside>
            <div class="card">
              <h4>إعدادات القيد</h4>

              <div class="field float-label" style="margin-top:10px">
                <select id="case_priority" placeholder=" ">
                  <option value="normal">عادية</option>
                  <option value="review">مراجعة</option>
                  <option value="urgent">عاجلة</option>
                </select>
                <label>الأولوية</label>
              </div>

              <div class="field float-label" style="margin-top:8px">
                <select id="case_status" placeholder=" ">
                  <option value="open">مفتوحة</option>
                  <option value="review">قيد المراجعة</option>
                  <option value="deferred">مؤجلة</option>
                </select>
                <label>الحالة</label>
              </div>

              <div class="field float-label" style="margin-top:8px">
                <input id="case_assigned" placeholder=" " />
                <label for="case_assigned">القاضي المعيّن (اختياري)</label>
              </div>

              <div style="margin-top:12px">
                <h5 class="muted-sm">ملاحظة</h5>
                <p class="muted-sm">ستتوفر وظائف متقدمة للتحقق الرقمي وتوقيع المرفقات عند الربط بالخادم.</p>
              </div>
            </div>
          </aside>
        </form>
      </section>

      <!-- Judge board -->
      <section id="panel-judgeboard" class="card" role="region" hidden>
        <h2 style="margin-top:0">منصة القاضي — قائمة القضايا</h2>
        <p class="muted">اضغط عرض لفتح تفاصيل القضية وتحريرها مباشرة.</p>
        <div class="card" style="margin-top:12px">
          <div id="judgeCaseList" class="case-list" aria-live="polite"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Drawer / side panel for case detail -->
  <aside id="judgeDrawer" class="drawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="drawerTitle" style="margin:0">تفاصيل القضية</h3>
      <div style="display:flex;gap:8px">
        <button id="closeDrawer" class="mini">إغلاق</button>
      </div>
    </div>

    <div class="field" style="margin-top:12px">
      <div class="float-label"><input id="f_caseid" placeholder=" " readonly /><label>رقم القضية</label></div>
    </div>

    <div class="field">
      <div class="float-label"><input id="f_internal" placeholder=" " /><label>الرقم الداخلي</label></div>
    </div>

    <div class="field">
      <div class="float-label"><input id="f_plaintiff" placeholder=" " /><label>اسم المدعي</label></div>
    </div>

    <div class="field">
      <div class="float-label"><input id="f_subject" placeholder=" " /><label>موضوع الدعوى</label></div>
    </div>

    <div class="field">
      <label>تاريخ الإنشاء</label>
      <div id="f_created" class="muted-sm"></div>
    </div>

    <div class="field">
      <div class="float-label">
        <select id="f_priority"><option value="urgent">عاجلة</option><option value="review">مراجعة</option><option value="normal">عادية</option></select>
        <label>الأولوية</label>
      </div>
    </div>

    <div class="field">
      <div class="float-label">
        <select id="f_status"><option value="open">مفتوحة</option><option value="review">قيد المراجعة</option><option value="completed">منجزة</option><option value="deferred">مؤجلة</option></select>
        <label>الحالة</label>
      </div>
    </div>

    <div class="field">
      <div class="float-label"><input id="f_assigned" placeholder=" " /><label>القاضي المعيّن</label></div>
    </div>

    <div class="field">
      <div class="float-label"><textarea id="f_notes" placeholder=" "></textarea><label>ملاحظات / ملخص</label></div>
    </div>

    <div class="field">
      <label>مرفقات</label>
      <div id="f_attachments" class="file-list"></div>
    </div>

    <div class="actions">
      <button id="f_save" class="btn">حفظ</button>
      <button id="f_assign" class="mini">تعيين</button>
      <button id="f_issue" class="mini">إصدار أمر</button>
      <button id="f_request_ai" class="mini">طلب اقتراح AI</button>
      <button id="f_print" class="mini">طباعة</button>
    </div>

    <div style="margin-top:12px" class="audit"><strong>سجل مختصر:</strong><div id="f_audit_list" class="muted-sm" style="margin-top:8px"></div></div>
  </aside>

  <div id="toastWrap" style="position:fixed;left:50%;transform:translateX(-50%);top:18px;z-index:2000" aria-live="polite"></div>

  <script>
    /* ================= Background animation (subtle, performant) ================= */
    (function(){
      const canvas = document.getElementById('bgCanvas'), ctx = canvas.getContext('2d');
      function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; canvas.style.width = innerWidth + 'px'; canvas.style.height = innerHeight + 'px'; }
      addEventListener('resize', resize); resize();

      const particles = [];
      const N = Math.max(24, Math.floor(window.innerWidth / 40));
      for(let i=0;i<N;i++) particles.push({ x: Math.random()*innerWidth, y: Math.random()*innerHeight, r: Math.random()*1.6+0.4, vx:(Math.random()-0.5)*0.25, vy:(Math.random()-0.5)*0.25, a: 0.06+Math.random()*0.2 });

      function frame(){
        ctx.clearRect(0,0,innerWidth,innerHeight);
        ctx.fillStyle = 'rgba(2,20,18,0.12)'; ctx.fillRect(0,0,innerWidth,innerHeight);
        // faint diagonal lines
        ctx.strokeStyle = 'rgba(10,80,60,0.03)';
        for(let i=0;i<18;i++){
          ctx.beginPath();
          const x = (i/18)*innerWidth + Math.sin(Date.now()*0.0006 + i)*20;
          ctx.moveTo(x, -40);
          ctx.lineTo(x+220, innerHeight+40);
          ctx.stroke();
        }
        // particles
        particles.forEach(p=>{
          p.x += p.vx; p.y += p.vy;
          if(p.x < -20) p.x = innerWidth + 20;
          if(p.x > innerWidth + 20) p.x = -20;
          if(p.y < -20) p.y = innerHeight + 20;
          if(p.y > innerHeight + 20) p.y = -20;
          const g = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*8);
          g.addColorStop(0, `rgba(140,240,200,${p.a})`); g.addColorStop(1, 'rgba(140,240,200,0)');
          ctx.fillStyle = g; ctx.beginPath(); ctx.arc(p.x,p.y,p.r*5,0,Math.PI*2); ctx.fill();
        });
        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    })();

    /* ================= Utilities ================= */
    const $ = (s, root=document) => root.querySelector(s);
    const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));
    function toast(msg, ttl=2200){
      const wrap = document.getElementById('toastWrap');
      const el = document.createElement('div'); el.textContent = msg;
      el.style.cssText = 'background:rgba(0,0,0,0.75);color:#fff;padding:8px 12px;border-radius:8px;margin-top:6px;display:inline-block';
      wrap.appendChild(el);
      setTimeout(()=> { el.style.opacity=0; setTimeout(()=> el.remove(),300); }, ttl);
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /* ================= Core: professional inputs behavior ================= */
    (function(){
      // assistant list + search dropdown (enhanced input)
      const AS_KEY = 'rwaq_assistants_rrrawan764-cloud';
      let assistants = [];
      function defaultAssistants(){ return [
        { id:'legal_expert', name:'الخبير القانوني', system:'أنت خبير قانوني. راجع النواقص وقدم توصيات.' },
        { id:'tech_auditor', name:'المدقق التقني', system:'أنت مدقق تقني. تحقّق من المرفقات والبيانات.' }
      ]; }
      function loadAssistants(){ try{ assistants = JSON.parse(localStorage.getItem(AS_KEY)) || defaultAssistants(); }catch(e){ assistants = defaultAssistants(); } renderAssistants(); }
      function saveAssistants(){ localStorage.setItem(AS_KEY, JSON.stringify(assistants)); }

      function renderAssistants(){
        const list = $('#assistantList'); list.innerHTML = '';
        assistants.forEach(a=>{
          const item = document.createElement('div'); item.className='assistant-item';
          item.innerHTML = `<div><div style="font-weight:700">${escapeHtml(a.name)}</div><div class="meta">${escapeHtml(a.system.slice(0,100))}${a.system.length>100?'...':''}</div></div>
            <div style="display:flex;gap:6px"><button class="mini" data-id="${a.id}" data-action="select">اختيار</button><button class="mini" data-id="${a.id}" data-action="edit">تعديل</button><button class="mini" data-id="${a.id}" data-action="delete">حذف</button></div>`;
          list.appendChild(item);
        });
        const sel = $('#assistantSelect'); sel.innerHTML = assistants.map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('');
        if(!sel.value && assistants.length) sel.value = assistants[0].id;
        renderAssistantDetails(currentAssistant());
      }

      function currentAssistant(){ const v = $('#assistantSelect').value; return assistants.find(a=>a.id===v) || assistants[0]; }
      function renderAssistantDetails(a){ $('#assistantDetails').innerHTML = a ? `<strong>${escapeHtml(a.name)}</strong><div class="muted-sm" style="margin-top:6px">${escapeHtml(a.system)}</div>` : 'لا يوجد مساعد محدد' }

      // dropdown search
      const asSearch = $('#assistantSearch'), asDrop = $('#assistantDropdown');
      asSearch.addEventListener('input', ()=> {
        const q = asSearch.value.trim().toLowerCase();
        const hits = assistants.filter(a => a.name.toLowerCase().includes(q) || a.system.toLowerCase().includes(q));
        if(!q){ asDrop.style.display='none'; return; }
        asDrop.innerHTML = hits.map(h => `<div data-id="${h.id}">${escapeHtml(h.name)} <div class="muted-sm" style="font-size:12px">${escapeHtml(h.system.slice(0,50))}</div></div>`).join('');
        asDrop.style.display = hits.length ? 'block' : 'none';
      });
      asDrop.addEventListener('click', (e)=> {
        const el = e.target.closest('[data-id]'); if(!el) return;
        const id = el.dataset.id; $('#assistantSelect').value = id; renderAssistantDetails(currentAssistant()); asDrop.style.display='none'; asSearch.value='';
      });

      // assistant list actions
      $('#assistantList').addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const id = btn.dataset.id, action = btn.dataset.action;
        const idx = assistants.findIndex(x=>x.id===id);
        if(action === 'select'){ $('#assistantSelect').value = id; renderAssistantDetails(assistants[idx]); toast('تم اختيار المساعد'); }
        if(action === 'edit'){ const a = assistants[idx]; const name = prompt('تعديل اسم المساعد:', a.name); if(!name) return; const system = prompt('نص النظام:', a.system); a.name = name; a.system = system || a.system; saveAssistants(); renderAssistants(); toast('تم التعديل'); }
        if(action === 'delete'){ if(confirm('حذف المساعد؟')){ assistants.splice(idx,1); saveAssistants(); renderAssistants(); toast('تم الحذف'); } }
      });

      $('#addAssistant').addEventListener('click', ()=> {
        const name = prompt('اسم المساعد الجديد:'); if(!name) return;
        const system = prompt('نص النظام/دور المساعد:', 'أنت مساعد قانوني.');
        const id = name.toLowerCase().replace(/\s+/g,'_') + '_' + Date.now().toString(36);
        assistants.unshift({ id, name, system }); saveAssistants(); renderAssistants(); toast('تم الإضافة');
      });

      // modes toggle (AR/UX)
      $$('.mode-btn').forEach(b => b.addEventListener('click', ()=> {
        $$('.mode-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
      }));

      // Run analysis (progressive + fallback)
      $('#runBtn').addEventListener('click', async ()=>{
        const text = $('#facts').value.trim();
        if(!text){ toast('أدخل ملخص الوقائع'); return; }
        const assistant = currentAssistant();
        const mode = (document.querySelector('.mode-btn.active')||{}).dataset.mode || 'concise';
        toggleRunning(true);
        $('#analysisResult').textContent = '';
        try{
          const res = await fetch('/api/ai/analyze', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text, assistant, mode }) });
          if(!res.ok) throw new Error('ai-unavailable');
          const json = await res.json();
          const out = json.raw || (json.verdict ? json.verdict + '\n\n' + (json.recommendations||[]).map((r,i)=>`${i+1}. ${r}`).join('\n') : JSON.stringify(json));
          await progressiveReveal(out);
          toast('اكتمل التحليل');
        }catch(e){
          const sim = `تحليل (${assistant.name}) — ${mode}\n\n• نقاط محتملة:\n- غياب إثبات التبليغ\n- نقص التفويض\n\nتوصيات:\n1. إرفاق إيصال\n2. طلب تفويض موقع`;
          await progressiveReveal(sim);
          toast('تم التحليل محلياً (وضع التجريبي)');
        }finally{ toggleRunning(false); }
      });

      function toggleRunning(r){
        $('#runBtn').disabled = r; $('#progressBar').style.display = r ? 'block' : 'none';
        if(!r) $('#progressBar i').style.width = '0%';
      }

      async function progressiveReveal(text){
        const el = $('#analysisResult'); el.textContent = '';
        const chars = Array.from(text);
        for(let i=0;i<chars.length;i++){ el.textContent += chars[i]; if(i%10===0) $('#progressBar i').style.width = Math.min(98, Math.round((i/chars.length)*100)) + '%'; await new Promise(r=>setTimeout(r, 8 + Math.random()*16)); }
        $('#progressBar i').style.width = '100%';
      }

      // file uploader: show list + simple client-side metadata
      const fileListNode = $('#fileList'), uploader = $('#caseUploader'), uploadProg = $('#caseUploadProgress');
      uploader.addEventListener('click', ()=> {
        const inp = document.createElement('input'); inp.type='file'; inp.multiple=true; inp.onchange = ()=> handleFiles(inp.files); inp.click();
      });
      ['dragenter','dragover'].forEach(ev=> uploader.addEventListener(ev, e=>{ e.preventDefault(); uploader.style.outline = '2px dashed rgba(15,176,107,0.5)'; }));
      ['dragleave','drop'].forEach(ev=> uploader.addEventListener(ev, e=>{ e.preventDefault(); uploader.style.outline=''; if(e.type==='drop') handleFiles(e.dataTransfer.files); }));
      function handleFiles(files){
        if(!files || files.length===0) return;
        for(const f of files){
          const id = 'f_' + Date.now() + Math.random().toString(36).slice(2,7);
          const node = document.createElement('div'); node.className='file-item'; node.innerHTML = `<div class="meta"><strong>${escapeHtml(f.name)}</strong><div class="muted-sm">${Math.round(f.size/1024)} KB • ${f.type || '—'}</div></div><div><button class="mini" data-id="${id}">حذف</button></div>`;
          node.dataset.id = id;
          fileListNode.appendChild(node);
        }
        toast('أضيفت ملفات (محلياً)');
      }
      fileListNode.addEventListener('click', (e)=>{ const btn = e.target.closest('button'); if(!btn) return; const parent = btn.closest('.file-item'); if(parent) parent.remove(); toast('تم حذف الملف محلياً'); });

      // Submit case (validation + save local / try server)
      $('#submitCase').addEventListener('click', async ()=>{
        $('#err_plaintiff').style.display='none'; $('#err_subject').style.display='none';
        const plaintiff = $('#case_plaintiff').value.trim(), subject = $('#case_subject').value.trim();
        if(!plaintiff){ $('#err_plaintiff').textContent='اسم المدعي مطلوب'; $('#err_plaintiff').style.display='block'; return; }
        if(!subject){ $('#err_subject').textContent='موضوع الدعوى مطلوب'; $('#err_subject').style.display='block'; return; }
        $('#caseFeedback').style.display='block'; $('#caseFeedback').textContent='قيد الدعوى...';
        const payload = {
          id: $('#case_id').value.trim() || 'C-' + Date.now().toString(36).toUpperCase(),
          internalId: $('#case_internal').value.trim(),
          plaintiff, subject, details: $('#case_details').value.trim(),
          priority: $('#case_priority').value, status: $('#case_status').value, assigned: $('#case_assigned').value.trim(),
          created: new Date().toISOString(), attachments: [], audit:[{actor:'نظام',action:'قيد محلي',at:new Date().toISOString()}]
        };
        try{
          const res = await fetch('/api/cases', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if(!res.ok) throw new Error('server');
          const data = await res.json();
          $('#caseFeedback').textContent = 'تم القيد — مرجع: ' + (data.id||payload.id);
          toast('تم قيد الدعوى عبر الخادم');
          saveCaseLocal(data);
        }catch(e){
          saveCaseLocal(payload);
          $('#caseFeedback').textContent = 'تم الحفظ محلياً';
          toast('تم الحفظ محلياً (شبكة غير متاحة)');
        }
      });

      // local case store
      const CASE_KEY = 'rwaq_cases_local';
      function saveCaseLocal(c){ const list = JSON.parse(localStorage.getItem(CASE_KEY) || '[]'); list.unshift(c); localStorage.setItem(CASE_KEY, JSON.stringify(list)); renderJudgeCaseList(); }
      function renderJudgeCaseList(){ const list = JSON.parse(localStorage.getItem(CASE_KEY) || '[]'); const el = $('#judgeCaseList'); el.innerHTML=''; if(!list || !list.length){ el.innerHTML = '<div class="muted">لا توجد قضايا محلية</div>'; return; } list.slice(0,50).forEach(c=>{ const row = document.createElement('div'); row.className='case-item'; row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='10px'; row.style.borderBottom='1px dashed rgba(255,255,255,0.03)'; row.innerHTML = `<div style="flex:1"><strong>${escapeHtml(c.plaintiff||'—')}</strong><div class="muted-sm">${escapeHtml(c.id||'—')} — ${escapeHtml(c.subject||'—')}</div></div><div style="min-width:140px;text-align:left"><div class="muted-sm">${new Date(c.created||Date.now()).toLocaleDateString()}</div><div style="margin-top:8px"><button class="mini" data-id="${c.id}" data-action="open">عرض</button> <button class="mini" data-id="${c.id}" data-action="ai">AI</button></div></div>`; el.appendChild(row); }); }

      // open drawer
      $('#judgeCaseList').addEventListener('click', (e)=>{ const btn = e.target.closest('button'); if(!btn) return; const id = btn.dataset.id, action = btn.dataset.action; const list = JSON.parse(localStorage.getItem(CASE_KEY) || '[]'); const c = list.find(x=>x.id === id); if(!c) return; if(action==='open') openDrawer(c); if(action==='ai'){ openDrawer(c); setTimeout(()=> $('#f_request_ai').click(), 120); } });

      function openDrawer(c){
        const d = $('#judgeDrawer'); d.classList.add('show');
        $('#drawerTitle').textContent = `قضية — ${c.id || ''}`;
        $('#f_caseid').value = c.id || '';
        $('#f_internal').value = c.internalId || '';
        $('#f_plaintiff').value = c.plaintiff || '';
        $('#f_subject').value = c.subject || '';
        $('#f_created').textContent = new Date(c.created || Date.now()).toLocaleString();
        $('#f_priority').value = c.priority || 'normal';
        $('#f_status').value = c.status || 'open';
        $('#f_assigned').value = c.assigned || '';
        $('#f_notes').value = c.details || c.notes || '';
        // attachments
        const att = $('#f_attachments'); att.innerHTML = ''; (c.attachments||[]).forEach(a=>{ const n = document.createElement('div'); n.className='file-item'; n.innerHTML = `<div class="meta">${escapeHtml(a.name)}</div><div><a class="mini" href="${a.url||'#'}" target="_blank">فتح</a></div>`; att.appendChild(n); });
        $('#f_audit_list').innerHTML = (c.audit||[]).map(x=>`${new Date(x.at).toLocaleString()} — ${escapeHtml(x.actor)}: ${escapeHtml(x.action)}`).join('<br>') || '<div class="muted-sm">لا سجلات</div>';
        d.dataset.caseId = c.id;
      }

      $('#closeDrawer').addEventListener('click', ()=> $('#judgeDrawer').classList.remove('show'));

      // drawer actions
      $('#f_save').addEventListener('click', ()=> {
        const id = $('#judgeDrawer').dataset.caseId; if(!id) return toast('لا توجد قضية مح��دة'); const list = JSON.parse(localStorage.getItem(CASE_KEY)||'[]'); const idx = list.findIndex(x=>x.id === id); if(idx<0) return toast('القضية غير موجودة محلياً'); list[idx].internalId = $('#f_internal').value.trim(); list[idx].plaintiff = $('#f_plaintiff').value.trim(); list[idx].subject = $('#f_subject').value.trim(); list[idx].priority = $('#f_priority').value; list[idx].status = $('#f_status').value; list[idx].assigned = $('#f_assigned').value.trim(); list[idx].notes = $('#f_notes').value.trim(); list[idx].audit = list[idx].audit || []; list[idx].audit.unshift({ actor:'مستخدم', action:'تعديل', at:new Date().toISOString() }); localStorage.setItem(CASE_KEY, JSON.stringify(list)); renderJudgeCaseList(); toast('تم حفظ التعديلات محلياً'); });

      $('#f_request_ai').addEventListener('click', async ()=> {
        const id = $('#judgeDrawer').dataset.caseId; if(!id) return;
        const btn = $('#f_request_ai'); btn.disabled = true; btn.textContent = 'جاري...';
        try{
          const res = await fetch('/api/ai/analyze',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ caseId: id }) });
          if(!res.ok) throw new Error('no-ai'); const json = await res.json(); const out = json.raw || json.verdict || 'لا نتيجة'; $('#f_notes').value += '\n\n[اقتراح AI]\n' + out; toast('أضيف اقتراح AI'); 
        }catch(e){ $('#f_notes').value += '\n\n[اقتراح تجريبي]\nراجع إثبات التبليغ.'; toast('فشل طلب الاقتراح — عرض محلي'); }
        finally{ btn.disabled = false; btn.textContent = 'طلب اقتراح AI'; }
      });

      // history
      function addHistory(entry){ const hist = JSON.parse(localStorage.getItem('rwaq_history_rrrawan764-cloud')||'[]'); hist.unshift(entry); if(hist.length>80) hist.length=80; localStorage.setItem('rwaq_history_rrrawan764-cloud', JSON.stringify(hist)); renderHistory(); }
      function renderHistory(){ const list = JSON.parse(localStorage.getItem('rwaq_history_rrrawan764-cloud')||'[]'); const container = $('#historyList'); container.innerHTML=''; if(!list || list.length===0){ container.innerHTML = '<div class="muted">لا يوجد سجل</div>'; return; } list.slice(0,50).forEach(h=>{ const n=document.createElement('div'); n.style.padding='8px'; n.style.borderBottom='1px dashed rgba(255,255,255,0.03)'; n.innerHTML=`<strong>${escapeHtml(h.assistant)}</strong><div class="muted-sm">${new Date(h.time).toLocaleString()}</div><div style="margin-top:8px"><button class="mini" data-time="${h.time}" data-a="view">عرض</button> <button class="mini" data-time="${h.time}" data-a="dl">تنزيل</button></div>`; container.appendChild(n); }); container.querySelectorAll('button').forEach(b=> b.addEventListener('click', ()=>{ const a = b.dataset.a, t = b.dataset.time; const hist = JSON.parse(localStorage.getItem('rwaq_history_rrrawan764-cloud')||'[]'); const e = hist.find(x=>x.time===t); if(!e) return; if(a==='view') $('#analysisResult').textContent = e.output || '[لا مخرج]'; if(a==='dl') downloadText(e.output||'', 'analysis-'+t+'.txt'); })); }

      function downloadText(content, filename){ const blob = new Blob([content||''], { type:'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

      // shortcuts
      window.addEventListener('keydown', e=>{ if((e.ctrlKey || e.metaKey) && e.key==='Enter') $('#runBtn').click(); });

      // open demo drawer
      $('#openJudgeDrawer').addEventListener('click', ()=> {
        const list = JSON.parse(localStorage.getItem(CASE_KEY)||'[]'); if(list && list[0]) openDrawer(list[0]); else toast('لا توجد قضايا محلية — أنشئ قيدًا أولاً');
      });

      // init
      function init(){ loadAssistants(); renderJudgeCaseList(); renderHistory(); }
      init();
    })();
  </script>
</body>
</html>
