<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>رواق العدل — المنصة المتكاملة</title>

  <!-- خط -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <meta name="description" content="رواق العدل — منصة قضائية متكاملة" />
  <meta name="author" content="روان الصبحي" />

  <style>
    :root{
      --bg-1:#f3f6f4;
      --bg-2:#eaf0ea;
      --glass: rgba(255,255,255,0.75);
      --muted:#51605a;
      --green:#116938;
      --gold:#FFB703;
      --accent: rgba(17,105,56,0.08);
      --radius:14px;
      --card-shadow: 0 18px 48px rgba(9,20,14,0.06);
      --ui-ease: cubic-bezier(.2,.9,.2,1);
      --max-width:1200px;
    }

    /* Reset & base */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Cairo',sans-serif;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#0b2a1a;-webkit-font-smoothing:antialiased}
    a{color:var(--green)}
    img{max-width:100%;height:auto}

    /* Subtle animated background sheen */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background: radial-gradient(600px 300px at 10% 10%, rgba(255,247,220,0.25), transparent 8%),
                  radial-gradient(500px 250px at 90% 90%, rgba(220,255,232,0.18), transparent 10%);
      mix-blend-mode: overlay; opacity:0.95; transform: translateZ(0);
      animation: bg-drift 18s linear infinite;
    }
    @keyframes bg-drift { 0%{transform:translateY(0) translateX(0)} 50%{transform:translateY(-18px) translateX(8px)} 100%{transform:translateY(0) translateX(0)} }

    /* Layout */
    .container{max-width:var(--max-width);margin:20px auto;padding:18px;display:grid;grid-template-columns:320px 1fr;gap:18px;min-height:80vh}
    @media (max-width:1000px){ .container{grid-template-columns:1fr; padding:12px} }

    /* Sidebar card */
    .sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.88), rgba(255,255,255,0.82));border-radius:16px;padding:18px;border:1px solid rgba(0,0,0,0.04);box-shadow:var(--card-shadow);backdrop-filter:blur(6px)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:86px;height:86px;border-radius:14px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--green),#0f5a31);box-shadow:0 12px 36px rgba(17,105,56,0.12);cursor:grab;transition:transform .36s var(--ui-ease)}
    .brand h1{margin:0;font-size:18px;color:#071018;font-weight:800}
    .brand p{margin:0;color:var(--muted);font-size:13px}

    /* animated logo micro-layer movement */
    .logo svg{width:68px;height:68px; transform-origin:center; transition:transform .28s var(--ui-ease)}

    nav.menu{margin-top:14px;display:flex;flex-direction:column;gap:8px}
    .menu button{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-weight:700;text-align:right;position:relative;overflow:visible}
    .menu .ico{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.6)}
    .menu button.active{background:linear-gradient(90deg,var(--accent), rgba(255,255,255,0.6));border-left:4px solid var(--gold);color:#071018}
    /* sliding active indicator */
    .side-indicator{position:absolute;left:-6px;top:0;bottom:auto;width:4px;height:44px;background:linear-gradient(180deg,var(--gold),#e6b153);border-radius:6px;transform:translateY(0);transition:transform .32s var(--ui-ease);pointer-events:none}

    .sidebar .foot{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}

    /* Main */
    .main{display:flex;flex-direction:column;gap:14px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .search{flex:1;max-width:760px;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.86));border:1px solid rgba(0,0,0,0.04);box-shadow:0 8px 30px rgba(0,0,0,0.03)}
    .search input{border:0;background:transparent;outline:none;padding:6px 8px;font-size:14px;color:#0b2a1a;width:100%}
    .controls{display:flex;gap:8px;align-items:center}

    .grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{border-radius:14px;padding:16px;background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));border:1px solid rgba(0,0,0,0.04);box-shadow:var(--card-shadow);backdrop-filter:blur(6px)}

    h2{margin:0 0 8px 0;color:var(--green)}
    h3{margin:0 0 8px 0;color:var(--gold)}
    .muted{color:var(--muted);font-size:13px}

    /* Glass inputs & interactions */
    .input, textarea, select { width:100%; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,0.04); background:rgba(255,255,255,0.9); outline:none; transition: box-shadow .12s, transform .12s; font-size:14px }
    textarea { min-height:120px; resize:vertical }
    .input:focus, textarea:focus { box-shadow:0 12px 30px rgba(17,105,56,0.08); transform:translateY(-3px); border-color: rgba(17,105,56,0.18); }

    /* Buttons & ripple */
    .btn{position:relative; overflow:hidden; background:linear-gradient(180deg,var(--green), #0d5b33); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800; box-shadow:0 10px 26px rgba(17,105,56,0.10)}
    .btn.secondary{background:transparent; color:var(--green); border:1px solid rgba(17,105,56,0.10); box-shadow:none}
    .ripple{ position:absolute; border-radius:50%; transform:scale(0); animation:ripple-effect .6s var(--ui-ease forwards); background:rgba(255,255,255,0.35); pointer-events:none; }
    @keyframes ripple-effect{ to { transform:scale(12); opacity:0; } }

    /* Uploader & progress */
    .uploader{border:2px dashed rgba(0,0,0,0.06);padding:14px;border-radius:10px;text-align:center;color:var(--muted);background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.75));transition:transform .12s}
    .uploader:active{transform:translateY(2px)}
    .progress{height:8px;background:#eef6ee;border-radius:8px;overflow:hidden;margin-top:8px}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--green),var(--gold));width:0%}

    .services-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .service{padding:14px;border-radius:12px;cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.86));border:1px solid rgba(0,0,0,0.04);transition:transform .14s,box-shadow .14s}
    .service:hover{transform:translateY(-6px);box-shadow:0 14px 40px rgba(10,20,14,0.06)}

    /* Toast */
    .toast-wrap{position:fixed;left:50%;transform:translateX(-50%);top:22px;display:flex;flex-direction:column;gap:8px;z-index:2000}
    .toast{background:#0b2a1a;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.25);opacity:0;transform:translateY(-6px) scale(.98);transition:opacity .28s,var(--ui-ease);display:inline-flex;gap:10px;align-items:center}
    .toast.show{opacity:1;transform:translateY(0) scale(1)}
    .toast.success{background:linear-gradient(90deg,var(--green),#0d5b33)}
    .toast.warn{background:linear-gradient(90deg,#f59e0b,#d97706)}

    /* small helpers */
    ul.list{list-style:none;padding:0;margin:0}
    ul.list li{padding:10px 0;border-bottom:1px dashed #eef;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:flex-end}
    .col{flex:1}

    :focus{outline:3px solid rgba(17,105,56,0.12);outline-offset:2px}
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="رواق العدل — المنصة المتكاملة">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="الشريط الجانبي">
      <div class="brand" role="img" aria-label="شعار رواق العدل">
        <div class="logo" id="brandLogo" tabindex="0" title="رواق العدل — الشعار الرسمي">
          <!-- SVG logo (swords + palm + scale) -->
          <svg viewBox="0 0 120 120" width="68" height="68" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
            <defs>
              <linearGradient id="g-green" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="#2aa05a"/><stop offset="1" stop-color="#116938"/>
              </linearGradient>
              <linearGradient id="g-gold" x1="0" x2="1"><stop offset="0" stop-color="#fff0b8"/><stop offset="1" stop-color="#FFB703"/></linearGradient>
              <filter id="ds" x="-50%" y="-50%" width="200%" height="200%"><feDropShadow dx="0" dy="3" stdDeviation="5" flood-color="#000" flood-opacity="0.18"/></filter>
            </defs>
            <g transform="translate(60,62)" opacity="0.96">
              <g transform="rotate(-28)"><rect x="-1.6" y="-48" width="3.2" height="92" rx="0.9" fill="#dcdcdc"/><polygon points="-7,-48 7,-48 0,-56" fill="#dcdcdc"/><rect x="-7" y="36" width="14" height="4.4" rx="1.1" fill="#b28627"/></g>
              <g transform="rotate(28)"><rect x="-1.6" y="-48" width="3.2" height="92" rx="0.9" fill="#dcdcdc"/><polygon points="-7,-48 7,-48 0,-56" fill="#dcdcdc"/><rect x="-7" y="36" width="14" height="4.4" rx="1.1" fill="#b28627"/></g>
            </g>
            <g transform="translate(60,36)" opacity="0.98">
              <rect x="-3.2" y="8" width="6.4" height="30" rx="1.2" fill="url(#g-green)" />
              <path d="M0,6 C8,0 20,-6 36,-4" fill="none" stroke="#1f8a4c" stroke-width="2.6" transform="translate(-18,-6) rotate(-18)"/>
              <path d="M0,6 C8,0 20,-6 36,-4" fill="none" stroke="#1f8a4c" stroke-width="2.6" transform="translate(-18,-6) rotate(18)"/>
            </g>
            <g transform="translate(60,48)" filter="url(#ds)">
              <rect x="-2.8" y="2" width="5.6" height="36" rx="1.4" fill="#cfcfcf"/>
              <g transform="translate(0,10)">
                <rect x="-30" y="-3.6" width="60" height="7.2" rx="3.6" fill="url(#g-gold)"/>
                <circle cx="0" cy="-14" r="4" fill="#cfcfcf"/>
                <line x1="-20" y1="-1" x2="-20" y2="14" stroke="#cfcfcf" stroke-width="1.1"/>
                <line x1="20" y1="-1" x2="20" y2="14" stroke="#cfcfcf" stroke-width="1.1"/>
                <g transform="translate(-20,26)"><ellipse rx="12.5" ry="4.8" fill="#fff3d6" stroke="#d1a94e" stroke-width="0.9"/></g>
                <g transform="translate(20,26)"><ellipse rx="12.5" ry="4.8" fill="#fff3d6" stroke="#d1a94e" stroke-width="0.9"/></g>
              </g>
              <rect x="-16" y="44" width="32" height="6" rx="2" fill="#2b2b2b" opacity="0.7"/>
            </g>
          </svg>
        </div>

        <div>
          <h1>رواق العدل</h1>
          <p class="muted">منصة قضائية متكاملة — أمان، وصول، وكفاءة</p>
        </div>
      </div>

      <!-- side indicator that moves -->
      <div class="side-indicator" id="sideIndicator" aria-hidden="true" style="position:relative;left:6px;top:80px"></div>

      <nav class="menu" role="navigation" aria-label="قائمة الخدمات">
        <button class="active" data-panel="assistant"><span class="ico"><i class="fa-solid fa-brain"></i></span>المساعد الذكي</button>
        <button data-panel="services"><span class="ico"><i class="fa-solid fa-layer-group"></i></span>الخدمات الشاملة</button>
        <button data-panel="casefile"><span class="ico"><i class="fa-solid fa-file-circle-plus"></i></span>قيد دعوى</button>
        <button data-panel="memo"><span class="ico"><i class="fa-solid fa-file-lines"></i></span>تبادل مذكرات</button>
        <button data-panel="sessions"><span class="ico"><i class="fa-solid fa-video"></i></span>جلسات رقمية</button>
        <button data-panel="judgeboard"><span class="ico"><i class="fa-solid fa-balance-scale"></i></span>منصة القاضي</button>
        <button data-panel="accessibility"><span class="ico"><i class="fa-solid fa-universal-access"></i></span>الوصول</button>
        <button data-panel="security"><span class="ico"><i class="fa-solid fa-shield"></i></span>الأمن</button>
      </nav>

      <div class="foot" style="margin-top:14px; text-align:center; color:var(--muted); font-size:13px">
        روان الصبحي — © 2026<br><a href="./LICENSE">شروط الترخيص</a>
      </div>
    </aside>

    <!-- Main -->
    <main class="main" role="main">
      <div class="topbar">
        <div class="search" role="search" aria-label="بحث موحد">
          <i class="fa-solid fa-magnifying-glass" style="color:var(--muted)"></i>
          <input id="unifiedSearch" placeholder="استعلام موحّد: رقم قضية، اسم، قرار..." />
        </div>

        <div class="controls">
          <button id="themeToggle" class="btn secondary" title="تبديل السمة">سمة</button>
          <button id="userBtn" class="btn secondary" title="حساب المستخدم">المحكمة الإلكترونية</button>
        </div>
      </div>

      <div class="grid">
        <!-- Panels -->
        <section id="panels" style="min-height:560px">
          <!-- Assistant -->
          <article id="panel-assistant" class="card panel" role="region" aria-labelledby="assistantTitle">
            <h2 id="assistantTitle">المساعد الذكي — تدقيق وتحليل</h2>
            <p class="muted">أدخل ملخص الوقائع أو ارفع المستندات. المساعد يقترح نقاط نواقص وتوصيات ومسودات.</p>

            <div style="margin-top:12px">
              <label for="facts" class="muted">ملخص الوقائع</label>
              <textarea id="facts" placeholder="اكتب ملخص الدعوى..." aria-label="ملخص الوقائع"></textarea>
            </div>

            <div style="margin-top:12px; display:flex; gap:12px; align-items:flex-start">
              <div style="flex:1">
                <div id="uploader" class="uploader" tabindex="0" aria-label="سحب الملفات أو الضغط للاختيار">اسحب الملفات هنا أو اضغط للاختيار (PDF، صور)</div>
                <div id="uploadProgress" class="progress" style="display:none"><i style="width:0%"></i></div>
              </div>

              <div style="width:220px; display:flex; flex-direction:column; gap:10px">
                <button id="runAi" class="btn" aria-live="polite" aria-busy="false">تشغيل التدقيق الذكي</button>
                <button id="saveDraft" class="btn secondary">حفظ مسودة</button>
              </div>
            </div>

            <div id="aiResult" style="margin-top:14px; display:none">
              <div class="card">
                <h3>نتيجة التحليل <span id="analysisSpinner" style="display:none; margin-left:8px"><i class="fa-solid fa-spinner fa-spin"></i></span></h3>
                <div id="analysisContent" class="muted">لا توجد نتيجة بعد.</div>
                <div style="margin-top:10px; display:flex; gap:8px">
                  <button id="exportDoc" class="btn">توليد مستند</button>
                  <button id="sendToJudge" class="btn secondary">إحالة إلى القاضي</button>
                </div>
              </div>
            </div>
          </article>

          <!-- Services -->
          <article id="panel-services" class="card panel" role="region" aria-labelledby="servicesTitle" hidden>
            <h2 id="servicesTitle">الخدمات الشاملة</h2>
            <p class="muted">بوابة موحدة للخدمات: قيد، مذكرات، جلسات، أرشفة، وتحليلات AI.</p>
            <div style="margin-top:12px" class="services-grid">
              <div class="service" data-service="casefile"><h4>قيد دعوى إلكتروني</h4><p class="muted">نموذج ذكي مع تحقق آلي من المرفقات.</p></div>
              <div class="service" data-service="memo"><h4>تبادل مذكرات</h4><p class="muted">صندوق وارد/صادر مع PKI.</p></div>
              <div class="service" data-service="sessions"><h4>جلسات رقمية</h4><p class="muted">روابط مؤمنة وتفريغ صوتي.</p></div>
              <div class="service" data-service="inquiry"><h4>استعلام موحّد</h4><p class="muted">بحث عن قضايا، أحكام وأطراف.</p></div>
            </div>
          </article>

          <!-- Case filing -->
          <article id="panel-casefile" class="card panel" role="region" aria-labelledby="casefileTitle" hidden>
            <h2 id="casefileTitle">قيد دعوى جديد</h2>
            <p class="muted">املأ الحقول وأرفق مستندات — المساعد سيتحقق قبل القيد.</p>
            <form id="caseForm" onsubmit="return false" style="margin-top:10px">
              <div class="row">
                <div class="col"><label class="muted">اسم المدعي</label><input id="plaintiff" class="input" required /></div>
                <div style="width:200px"><label class="muted">رقم القضية (اختياري)</label><input id="caseNumber" class="input" /></div>
              </div>
              <div style="margin-top:10px"><label class="muted">موضوع الدعوى</label><input id="subject" class="input" required /></div>
              <div style="margin-top:10px"><label class="muted">تفاصيل</label><textarea id="details" class="input" required></textarea></div>
              <div style="display:flex; gap:8px; align-items:center; margin-top:10px">
                <div style="flex:1"><div id="caseUploader" class="uploader">اسحب مستندات الدعوى أو اضغط للاختيار</div></div>
                <div style="width:160px"><button id="submitCase" class="btn">قيد الدعوى</button></div>
              </div>
              <div id="caseFeedback" class="muted" style="margin-top:8px; display:none"></div>
            </form>
          </article>

          <!-- Memo -->
          <article id="panel-memo" class="card panel" role="region" aria-labelledby="memoTitle" hidden>
            <h2 id="memoTitle">تبادل مذكرات</h2>
            <div style="display:flex; gap:12px; margin-top:10px">
              <div style="flex:1"><ul id="memoList" class="list"></ul></div>
              <div style="width:300px"><label class="muted">مذكرة جديدة</label><textarea id="memoText" class="input"></textarea><button id="sendMemo" class="btn" style="margin-top:8px">إرسال</button></div>
            </div>
          </article>

          <!-- Sessions -->
          <article id="panel-sessions" class="card panel" role="region" aria-labelledby="sessionsTitle" hidden>
            <h2 id="sessionsTitle">جلسات رقمية</h2>
            <div style="margin-top:10px"><label class="muted">موضوع الجلسة</label><input id="sessionSubj" class="input" /><div class="row" style="margin-top:8px"><div class="col"><label class="muted">التاريخ والوقت</label><input id="sessionDate" type="datetime-local" class="input" /></div><div style="width:150px"><button id="createSession" class="btn">إنشاء جلسة</button></div></div><div id="sessionList" style="margin-top:12px"></div></div>
          </article>

          <!-- Judge -->
          <article id="panel-judgeboard" class="card panel" role="region" aria-labelledby="judgeTitle" hidden>
            <h2 id="judgeTitle">منصة القاضي</h2>
            <div style="display:flex; gap:12px; margin-top:12px">
              <div style="flex:1" class="card"><h3>قضايا اليوم</h3><div id="todayCases" class="muted">تحميل...</div></div>
              <div style="width:320px" class="card"><h3>مخطط الحالة</h3><canvas id="judgeChart" style="max-height:160px"></canvas></div>
            </div>
          </article>

          <!-- Accessibility -->
          <article id="panel-accessibility" class="card panel" role="region" aria-labelledby="accessTitle" hidden>
            <h2 id="accessTitle">الوصول</h2>
            <div style="display:flex; gap:8px; margin-top:10px"><button id="enableTTS" class="btn">تشغيل القراءة</button><button id="enableCaptions" class="btn secondary">عرض الترجمة</button><button id="startSTT" class="btn secondary">بدء أوامر صوتية</button></div>
          </article>

          <!-- Security -->
          <article id="panel-security" class="card panel" role="region" aria-labelledby="securityTitle" hidden>
            <h2 id="securityTitle">الأمن والامتثال</h2>
            <ul class="muted" style="margin-top:8px">
              <li>حماية مفاتيح في Secret Manager</li><li>MFA وRBAC</li><li>سجلات تدقيق قابلة للتصدير</li>
            </ul>
          </article>
        </section>

        <!-- RIGHT -->
        <aside class="right-col">
          <div class="card"><h3>إجراءات سريعة</h3><div style="display:flex;flex-direction:column;gap:8px;margin-top:10px"><button class="btn" onclick="openPanel('casefile')">قيد دعوى</button><button class="btn secondary" onclick="openPanel('memo')">مذكرة</button><button class="btn secondary" onclick="openPanel('sessions')">جلسة</button></div></div>
          <div class="card"><h3>التكاملات</h3><p class="muted" style="margin-top:8px">OpenAI · Azure Speech · Google OCR · PKI · S3 · SSO</p><button class="btn secondary" onclick="alert('راجع إعدادات infra')">تفاصيل الربط</button></div>
          <div class="card"><h3>التواصل</h3><p class="muted" style="margin-top:8px">licensing@rawan.dev</p><button class="btn" onclick="location.href='mailto:licensing@rawan.dev'">اتصل</button></div>
        </aside>
      </div>

      <footer class="footer card" style="text-align:center">© 2026 روان الصبحي — جميع الحقوق محفوظة</footer>
    </main>
  </div>

  <!-- toast container -->
  <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

  <script>
    // Small utility helpers
    const $ = (s, root=document) => root.querySelector(s);
    const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

    // Ripple effect for buttons
    function attachRipples(){
      document.addEventListener('pointerdown', e => {
        const btn = e.target.closest('.btn');
        if(!btn) return;
        const rect = btn.getBoundingClientRect();
        const r = document.createElement('span');
        r.className = 'ripple';
        const size = Math.max(rect.width, rect.height);
        r.style.width = r.style.height = size + 'px';
        const x = e.clientX - rect.left - size/2;
        const y = e.clientY - rect.top - size/2;
        r.style.left = x + 'px'; r.style.top = y + 'px';
        btn.appendChild(r);
        r.addEventListener('animationend', ()=> r.remove());
      });
    }
    attachRipples();

    // Toast notifications
    const toastWrap = $('#toastWrap');
    function showToast(message, type='default', ttl=3500){
      const t = document.createElement('div');
      t.className = 'toast' + (type ? ' ' + (type==='success' ? 'success' : type==='warn' ? 'warn' : '') : '');
      t.innerHTML = `<div>${message}</div>`;
      toastWrap.appendChild(t);
      // small delay to allow CSS transition
      requestAnimationFrame(()=> t.classList.add('show'));
      setTimeout(()=> {
        t.classList.remove('show');
        setTimeout(()=> t.remove(), 340);
      }, ttl);
    }

    // Menu active indicator movement
    const sideIndicator = document.getElementById('sideIndicator');
    function moveIndicatorTo(button){
      if(!button) return;
      const rect = button.getBoundingClientRect();
      const parentRect = document.querySelector('.sidebar').getBoundingClientRect();
      const y = rect.top - parentRect.top + (rect.height - 44)/2 + 12; // adjust
      sideIndicator.style.transform = `translateY(${y}px)`;
    }
    // initial position
    document.addEventListener('DOMContentLoaded', ()=> {
      const active = document.querySelector('.menu button.active');
      if(active) moveIndicatorTo(active);
    });

    // menu clicks + sliding indicator + panel open
    $$('.menu button').forEach(btn=>{
      btn.addEventListener('click', (e) => {
        $$('.menu button').forEach(b=> b.classList.remove('active'));
        btn.classList.add('active');
        moveIndicatorTo(btn);
        openPanel(btn.dataset.panel);
      });
      // keyboard accessibility
      btn.addEventListener('keydown', (ev) => { if(ev.key === 'Enter') btn.click(); });
    });

    // Logo microinteraction (mouse tilt)
    const brandLogo = document.getElementById('brandLogo');
    brandLogo.addEventListener('mousemove', (e) => {
      const rect = brandLogo.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;
      const dx = (e.clientX - cx) / rect.width;
      const dy = (e.clientY - cy) / rect.height;
      brandLogo.style.transform = `perspective(600px) rotateX(${dy*6}deg) rotateY(${dx*-6}deg) translateZ(2px)`;
      const svg = brandLogo.querySelector('svg');
      if(svg) svg.style.transform = `translateY(${dy*-4}px) translateX(${dx*4}px)`;
    });
    brandLogo.addEventListener('mouseleave', ()=> { brandLogo.style.transform=''; const svg = brandLogo.querySelector('svg'); if(svg) svg.style.transform=''; });
    brandLogo.addEventListener('keydown', (e)=> { if(e.key==='Enter') { brandLogoPulse(); showToast('رواق العدل — الترحيب', 'success', 1800); } });
    function brandLogoPulse(){ brandLogo.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}], { duration: 300, easing: 'ease-out' }); }

    // Panels logic
    function openPanel(name){
      const map = { assistant:'panel-assistant', services:'panel-services', casefile:'panel-casefile', memo:'panel-memo', sessions:'panel-sessions', judgeboard:'panel-judgeboard', accessibility:'panel-accessibility', security:'panel-security' };
      Object.values(map).forEach(id => { const el=document.getElementById(id); if(el) el.hidden = true; });
      const id = map[name] || ('panel-' + name);
      const el = document.getElementById(id);
      if(el) el.hidden = false;
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // Setup uploader (presign + upload)
    function setupUploader(elId, progressId){
      const el = document.getElementById(elId), progress = document.getElementById(progressId);
      el.addEventListener('click', ()=> {
        const inp = document.createElement('input'); inp.type='file'; inp.multiple=true;
        inp.onchange = ()=> handleFiles(inp.files, progress);
        inp.click();
      });
      ['dragenter','dragover'].forEach(ev => el.addEventListener(ev, e => { e.preventDefault(); el.style.borderColor = 'var(--green)'; }));
      ['dragleave','drop'].forEach(ev => el.addEventListener(ev, e => { e.preventDefault(); el.style.borderColor = ''; if(ev==='drop' || e.type==='drop'){ handleFiles(e.dataTransfer.files, progress); } }));
    }

    async function presign(filename, contentType){
      // call backend presign endpoint — ensure backend is configured
      try {
        const res = await fetch('/api/upload/presign', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ filename, contentType })});
        if(!res.ok) throw new Error('presign failed');
        return await res.json();
      } catch(err){ throw err; }
    }

    async function uploadToUrl(url, file){
      const res = await fetch(url, { method:'PUT', body: file, headers:{ 'Content-Type': file.type }});
      if(!res.ok) throw new Error('upload failed');
      return true;
    }

    async function handleFiles(files, progressEl){
      if(!files || files.length === 0) return;
      progressEl.style.display = 'block';
      const bar = progressEl.querySelector('i');
      bar.style.width = '0%';
      try {
        for(let i=0;i<files.length;i++){
          const f = files[i];
          const pre = await presign(f.name, f.type || 'application/octet-stream');
          await uploadToUrl(pre.url, f);
          bar.style.width = `${Math.round(((i+1)/files.length)*100)}%`;
        }
        setTimeout(()=> { progressEl.style.display = 'none'; bar.style.width='0%'; showToast('تم رفع الملف/الملفات بنجاح', 'success'); }, 400);
      } catch (err){
        progressEl.style.display = 'none'; bar.style.width='0%'; showToast('فشل الرفع: ' + err.message, 'warn');
      }
    }

    setupUploader('uploader','uploadProgress');
    setupUploader('caseUploader','uploadProgress');

    // AI analyze
    $('#runAi').addEventListener('click', async () => {
      const text = $('#facts').value.trim();
      if(!text) { showToast('اكتب ملخص الوقائع قبل التشغيل', 'warn'); return; }
      const resultBlock = $('#aiResult'); const content = $('#analysisContent'); const spinner = $('#analysisSpinner');
      resultBlock.style.display = 'block'; spinner.style.display = 'inline-block'; $('#runAi').setAttribute('aria-busy','true'); showToast('جاري التحليل — الرجاء الانتظا��...', 'default', 1800);
      try {
        const res = await fetch('/api/ai/analyze', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ text })});
        if(!res.ok) throw new Error('AI error');
        const json = await res.json();
        spinner.style.display = 'none'; $('#runAi').setAttribute('aria-busy','false'); showToast('اكتمل التحليل', 'success');
        if(json.raw) content.innerText = json.raw;
        else if(json.verdict) content.innerHTML = `<strong>${json.verdict}</strong><ul style="margin:8px 0 0 0;padding-inline-start:18px">${(json.issues||[]).map(i=>`<li>${i}</li>`).join('')}</ul><div style="margin-top:8px"><strong>توصيات:</strong><ol style="margin:6px 0 0 0;padding-inline-start:18px">${(json.recommendations||[]).map(r=>`<li>${r}</li>`).join('')}</ol></div>`;
        else content.innerText = JSON.stringify(json, null, 2);
      } catch(err){
        spinner.style.display = 'none'; $('#runAi').setAttribute('aria-busy','false'); content.textContent = 'خطأ في التحليل: ' + err.message; showToast('خطأ في تحليل AI', 'warn');
      }
    });

    // Case create
    $('#submitCase').addEventListener('click', async () => {
      const plaintiff = $('#plaintiff').value.trim(), subject = $('#subject').value.trim(), details = $('#details').value.trim();
      const fb = $('#caseFeedback'); if(!plaintiff || !subject || !details){ fb.style.display='block'; fb.textContent='يرجى ملء الحقول المطلوبة.'; return; }
      fb.style.display='block'; fb.textContent='جاري إرسال طلب القيد...';
      try {
        const res = await fetch('/api/cases', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ plaintiff, subject, details, attachments: [] }) });
        if(!res.ok) throw new Error('create case failed');
        const data = await res.json();
        fb.textContent = 'تم قيد الدعوى رقم: ' + data.id; showToast('تم قيد الدعوى', 'success');
      } catch(err){
        fb.textContent = 'خطأ عند القيد: ' + err.message; showToast('خطأ في قيد الدعوى', 'warn');
      }
    });

    // Memos load/send
    async function loadMemos(){
      try {
        const res = await fetch('/api/memos'); if(!res.ok) throw new Error();
        const list = await res.json();
        $('#memoList').innerHTML = list.map(m => `<li><strong>${m.from}</strong> — ${m.time? new Date(m.time).toLocaleString():''}<div style="font-size:13px;color:var(--muted);margin-top:6px">${m.text}</div></li>`).join('');
      } catch(e) { $('#memoList').innerHTML = '<li class="muted">تعذر تحميل المذكرات</li>'; }
    }
    loadMemos();
    $('#sendMemo').addEventListener('click', async ()=> {
      const text = $('#memoText').value.trim(); if(!text) return showToast('اكتب نص المذكرة', 'warn');
      const res = await fetch('/api/memos', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ text, from: 'أنت' }) });
      if(!res.ok) return showToast('فشل إرسال المذكرة', 'warn');
      $('#memoText').value=''; showToast('تم إرسال المذكرة', 'success'); loadMemos();
    });

    // Sessions
    document.getElementById('createSession').addEventListener('click', async ()=> {
      const subj = $('#sessionSubj').value.trim(), datetime = $('#sessionDate').value;
      if(!subj || !datetime) return showToast('ادخل الموضوع والتاريخ', 'warn');
      const res = await fetch('/api/sessions', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ subj, datetime })});
      if(!res.ok) return showToast('فشل إنشاء الجلسة', 'warn');
      const s = await res.json(); renderSessions([s, ...(window._sessions||[]) ]);
      showToast('تم إنشاء الجلسة', 'success');
    });
    function renderSessions(list){ window._sessions = list; $('#sessionList').innerHTML = list.map(s => `<div style="padding:8px;border-bottom:1px solid #f0f4f0"><strong>${s.subj}</strong><div class="muted">${new Date(s.datetime).toLocaleString()}</div><a href="${s.link}" target="_blank">${s.link}</a></div>`).join(''); }

    // Judge chart init
    (function initJudgeChart(){
      const ctx = document.getElementById('judgeChart'); if(!ctx) return;
      new Chart(ctx, { type:'doughnut', data:{ labels:['منجز','قيد','نواقص'], datasets:[{ data:[1420,85,12], backgroundColor:['#FFB703','#116938','#ff6b6b'] }] }, options:{plugins:{legend:{position:'bottom'}}} });
      const t = document.getElementById('todayCases'); if(t) t.textContent = 'قضايا مؤكدة: 27 — عاجلة: 3';
    })();

    // Accessibility: TTS & STT
    $('#enableTTS').addEventListener('click', ()=> {
      const text = $('#analysisContent').innerText || 'لا توجد نتائج';
      if('speechSynthesis' in window){ const u = new SpeechSynthesisUtterance(text); u.lang='ar-SA'; speechSynthesis.speak(u); showToast('تشغيل القراءة', 'success'); } else showToast('TTS غير مدعوم', 'warn');
    });

    $('#startSTT').addEventListener('click', ()=> {
      if(!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) return showToast('STT غير مدعوم — اربط خدمة ASR', 'warn');
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition; const r = new SR(); r.lang='ar-SA'; r.interimResults = true;
      r.onresult = e => { $('#facts').value = Array.from(e.results).map(r=>r[0].transcript).join(''); };
      r.onerror = ()=> showToast('فشل التعرف الصوتي', 'warn'); r.start();
    });

    // Theme toggle (simple)
    $('#themeToggle').addEventListener('click', ()=> {
      const root = document.documentElement;
      if(getComputedStyle(root).getPropertyValue('--bg-1') === '#071018'){ root.style.removeProperty('--bg-1'); root.style.removeProperty('--bg-2'); document.body.style.color = '#0b2a1a'; showToast('سمة فاتحة', 'default'); }
      else { root.style.setProperty('--bg-1','#071018'); root.style.setProperty('--bg-2','#041016'); document.body.style.color = '#eaf2eb'; showToast('سمة داكنة', 'default'); }
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', e => {
      if(e.key === '1') openPanel('assistant');
      if(e.key === '2') openPanel('services');
      if(e.key === '3') openPanel('casefile');
      if(e.key === '4') openPanel('memo');
      if(e.key === '5') openPanel('sessions');
      if(e.key === '6') openPanel('judgeboard');
    });
  </script>
</body>
</html>
