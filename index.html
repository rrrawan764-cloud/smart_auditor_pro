<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>رواق العدل — المنصة المتكاملة</title>

  <!-- خط -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <meta name="description" content="رواق العدل — منصة قضائية متكاملة" />
  <meta name="author" content="روان الصبحي" />

  <style>
    :root{
      --bg-1:#071918; /* darker to match interactive tech background */
      --bg-2:#042a24;
      --muted:#93a79f;
      --green:#0fb06b;
      --gold:#FFB703;
      --accent: rgba(15,176,107,0.06);
      --radius:14px;
      --card-shadow: 0 18px 48px rgba(0,0,0,0.55);
      --ui-ease: cubic-bezier(.2,.9,.2,1);
      --max-width:1200px;
    }

    /* Reset & base */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Cairo',sans-serif;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#e6fff4;-webkit-font-smoothing:antialiased}
    a{color:var(--green)}
    img{max-width:100%;height:auto}

    /* Canvas background (interactive) */
    #bgCanvas {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      z-index: -2;
      display: block;
      background: linear-gradient(180deg, rgba(2,18,16,0.9), rgba(3,28,24,0.95));
    }

    /* subtle overlay to soften canvas and create glass effect */
    .bg-overlay {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: linear-gradient(180deg, rgba(0,15,12,0.45), rgba(0,10,8,0.6));
      pointer-events: none;
      mix-blend-mode: overlay;
    }

    /* Container & layout */
    .container{max-width:var(--max-width);margin:20px auto;padding:18px;display:grid;grid-template-columns:320px 1fr;gap:18px;min-height:80vh;position:relative;z-index:0}
    @media (max-width:1000px){ .container{grid-template-columns:1fr; padding:12px} }

    /* Sidebar card */
    .sidebar{background: rgba(255,255,255,0.03); border-radius:16px; padding:18px; border:1px solid rgba(255,255,255,0.03); box-shadow:var(--card-shadow); backdrop-filter: blur(8px)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:86px;height:86px;border-radius:14px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(15,176,107,0.95), rgba(6,100,72,0.95));box-shadow:0 12px 36px rgba(0,0,0,0.6);cursor:grab;transition:transform .36s var(--ui-ease)}
    .brand h1{margin:0;font-size:18px;color:#e6fff4;font-weight:800}
    .brand p{margin:0;color:var(--muted);font-size:13px}

    nav.menu{margin-top:14px;display:flex;flex-direction:column;gap:8px}
    .menu button{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-weight:700;text-align:right;position:relative;overflow:visible}
    .menu .ico{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.04)}
    .menu button.active{background:linear-gradient(90deg,rgba(15,176,107,0.06), rgba(255,255,255,0.02));border-left:4px solid var(--gold);color:#dff8ea}

    .sidebar .foot{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}

    /* Main content styling */
    .main{display:flex;flex-direction:column;gap:14px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .search{flex:1;max-width:760px;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);box-shadow:0 6px 18px rgba(0,0,0,0.5)}
    .search input{border:0;background:transparent;outline:none;padding:6px 8px;font-size:14px;color:#e6fff4;width:100%}
    .controls{display:flex;gap:8px;align-items:center}

    .grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{border-radius:14px;padding:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 36px rgba(0,0,0,0.5);backdrop-filter: blur(6px)}
    h2{margin:0 0 8px 0;color:var(--green)}
    h3{margin:0 0 8px 0;color:var(--gold)}
    .muted{color:var(--muted);font-size:13px}

    /* inputs */
    .input, textarea, select { width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background: rgba(0,0,0,0.18); color:#eafff0; outline:none; transition: box-shadow .12s, transform .12s; font-size:14px }
    textarea { min-height:120px; resize:vertical }
    .input:focus, textarea:focus { box-shadow: 0 12px 30px rgba(0,150,120,0.06); transform:translateY(-3px); border-color: rgba(15,176,107,0.18); }

    .btn{position:relative; overflow:hidden; background:linear-gradient(180deg,var(--green), #0b7d56); color:#042b22; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800}
    .btn.secondary{background:transparent; color:var(--green); border:1px solid rgba(15,176,107,0.12)}

    .uploader{border:2px dashed rgba(255,255,255,0.03); padding:14px; border-radius:10px; text-align:center; color:var(--muted); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); transition:transform .12s}
    .uploader:active{transform:translateY(2px)}

    .services-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .service{padding:14px;border-radius:12px;cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);transition:transform .14s,box-shadow .14s}
    .service:hover{transform:translateY(-6px);box-shadow:0 14px 40px rgba(0,0,0,0.5)}

    /* toast */
    .toast-wrap{position:fixed;left:50%;transform:translateX(-50%);top:22px;display:flex;flex-direction:column;gap:8px;z-index:2000}
    .toast{background:rgba(0,0,0,0.7);color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6);opacity:0;transform:translateY(-6px) scale(.98);transition:opacity .28s,var(--ui-ease);display:inline-flex;gap:10px;align-items:center}
    .toast.show{opacity:1;transform:translateY(0) scale(1)}

    /* small helpers */
    ul.list{list-style:none;padding:0;margin:0}
    ul.list li{padding:10px 0;border-bottom:1px dashed rgba(255,255,255,0.03);color:var(--muted)}
    .row{display:flex;gap:10px;align-items:flex-end}
    .col{flex:1}

    :focus{outline:3px solid rgba(15,176,107,0.08);outline-offset:2px}
  </style>
</head>
<body>
  <!-- Interactive canvas background -->
  <canvas id="bgCanvas" aria-hidden="true"></canvas>
  <div class="bg-overlay" aria-hidden="true"></div>

  <div class="container" role="application" aria-label="رواق العدل — المنصة المتكاملة">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="الشريط الجانبي">
      <div class="brand" role="img" aria-label="شعار رواق العدل">
        <div class="logo" id="brandLogo" tabindex="0" title="رواق العدل — الشعار الرسمي">
          <!-- SVG logo -->
          <svg viewBox="0 0 120 120" width="68" height="68" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
            <defs>
              <linearGradient id="g-green" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#2aa05a"/><stop offset="1" stop-color="#116938"/></linearGradient>
              <linearGradient id="g-gold" x1="0" x2="1"><stop offset="0" stop-color="#fff0b8"/><stop offset="1" stop-color="#FFB703"/></linearGradient>
              <filter id="ds" x="-50%" y="-50%" width="200%" height="200%"><feDropShadow dx="0" dy="3" stdDeviation="5" flood-color="#000" flood-opacity="0.18"/></filter>
            </defs>
            <g transform="translate(60,62)" opacity="0.96">
              <g transform="rotate(-28)"><rect x="-1.6" y="-48" width="3.2" height="92" rx="0.9" fill="#dcdcdc"/><polygon points="-7,-48 7,-48 0,-56" fill="#dcdcdc"/><rect x="-7" y="36" width="14" height="4.4" rx="1.1" fill="#b28627"/></g>
              <g transform="rotate(28)"><rect x="-1.6" y="-48" width="3.2" height="92" rx="0.9" fill="#dcdcdc"/><polygon points="-7,-48 7,-48 0,-56" fill="#dcdcdc"/><rect x="-7" y="36" width="14" height="4.4" rx="1.1" fill="#b28627"/></g>
            </g>
            <g transform="translate(60,36)" opacity="0.98">
              <rect x="-3.2" y="8" width="6.4" height="30" rx="1.2" fill="url(#g-green)" />
              <path d="M0,6 C8,0 20,-6 36,-4" fill="none" stroke="#1f8a4c" stroke-width="2.6" transform="translate(-18,-6) rotate(-18)"/>
              <path d="M0,6 C8,0 20,-6 36,-4" fill="none" stroke="#1f8a4c" stroke-width="2.6" transform="translate(-18,-6) rotate(18)"/>
            </g>
            <g transform="translate(60,48)" filter="url(#ds)">
              <rect x="-2.8" y="2" width="5.6" height="36" rx="1.4" fill="#cfcfcf"/>
              <g transform="translate(0,10)">
                <rect x="-30" y="-3.6" width="60" height="7.2" rx="3.6" fill="url(#g-gold)"/>
                <circle cx="0" cy="-14" r="4" fill="#cfcfcf"/>
                <line x1="-20" y1="-1" x2="-20" y2="14" stroke="#cfcfcf" stroke-width="1.1"/>
                <line x1="20" y1="-1" x2="20" y2="14" stroke="#cfcfcf" stroke-width="1.1"/>
                <g transform="translate(-20,26)"><ellipse rx="12.5" ry="4.8" fill="#fff3d6" stroke="#d1a94e" stroke-width="0.9"/></g>
                <g transform="translate(20,26)"><ellipse rx="12.5" ry="4.8" fill="#fff3d6" stroke="#d1a94e" stroke-width="0.9"/></g>
              </g>
              <rect x="-16" y="44" width="32" height="6" rx="2" fill="#2b2b2b" opacity="0.7"/>
            </g>
          </svg>
        </div>

        <div>
          <h1>رواق العدل</h1>
          <p class="muted">منصة قضائية متكاملة — أمان، وصول، وكفاءة</p>
        </div>
      </div>

      <nav class="menu" role="navigation" aria-label="قائمة الخدمات">
        <button class="active" data-panel="assistant"><span class="ico"><i class="fa-solid fa-brain"></i></span>المساعد الذكي</button>
        <button data-panel="services"><span class="ico"><i class="fa-solid fa-layer-group"></i></span>الخدمات الشاملة</button>
        <button data-panel="casefile"><span class="ico"><i class="fa-solid fa-file-circle-plus"></i></span>قيد دعوى</button>
        <button data-panel="memo"><span class="ico"><i class="fa-solid fa-file-lines"></i></span>تبادل مذكرات</button>
        <button data-panel="sessions"><span class="ico"><i class="fa-solid fa-video"></i></span>جلسات رقمية</button>
        <button data-panel="judgeboard"><span class="ico"><i class="fa-solid fa-balance-scale"></i></span>منصة القاضي</button>
        <button data-panel="accessibility"><span class="ico"><i class="fa-solid fa-universal-access"></i></span>الوصول</button>
        <button data-panel="security"><span class="ico"><i class="fa-solid fa-shield"></i></span>الأمن</button>
      </nav>

      <div class="foot" style="margin-top:14px; text-align:center; color:var(--muted); font-size:13px">
        روان الصبحي — © 2026<br><a href="./LICENSE">شروط الترخيص</a>
      </div>
    </aside>

    <!-- Main -->
    <main class="main" role="main">
      <div class="topbar">
        <div class="search" role="search" aria-label="بحث موحد">
          <i class="fa-solid fa-magnifying-glass" style="color:var(--muted)"></i>
          <input id="unifiedSearch" placeholder="استعلام موحّد: رقم قضية، اسم، قرار..." />
        </div>

        <div class="controls">
          <button id="themeToggle" class="btn secondary" title="تبديل السمة">سمة</button>
          <button id="userBtn" class="btn secondary" title="حساب المستخدم">المحكمة الإلكترونية</button>
        </div>
      </div>

      <div class="grid">
        <!-- Panels (kept same as previous; omitted here for brevity in comment) -->
        <section id="panels" style="min-height:560px">
          <!-- Assistant panel (kept) -->
          <article id="panel-assistant" class="card panel" role="region" aria-labelledby="assistantTitle">
            <h2 id="assistantTitle">المساعد الذكي — تدقيق وتحليل</h2>
            <p class="muted">أدخل ملخص الوقائع أو ارفع المستندات. المساعد يقترح نقاط نواقص وتوصيات ومسودات.</p>
            <div style="margin-top:12px">
              <label for="facts" class="muted">ملخص الوقائع</label>
              <textarea id="facts" placeholder="اكتب ملخص الدعوى..." aria-label="ملخص الوقائع"></textarea>
            </div>
            <div style="margin-top:12px; display:flex; gap:12px; align-items:flex-start">
              <div style="flex:1">
                <div id="uploader" class="uploader" tabindex="0" aria-label="سحب الملفات أو الضغط للاختيار">اسحب الملفات هنا أو اضغط للاختيار (PDF، صور)</div>
                <div id="uploadProgress" class="progress" style="display:none"><i style="width:0%"></i></div>
              </div>
              <div style="width:220px; display:flex; flex-direction:column; gap:10px">
                <button id="runAi" class="btn" aria-live="polite" aria-busy="false">تشغيل التدقيق الذكي</button>
                <button id="saveDraft" class="btn secondary">حفظ مسودة</button>
              </div>
            </div>
            <div id="aiResult" style="margin-top:14px; display:none">
              <div class="card">
                <h3>نتيجة التحليل <span id="analysisSpinner" style="display:none; margin-left:8px"><i class="fa-solid fa-spinner fa-spin"></i></span></h3>
                <div id="analysisContent" class="muted">لا توجد نتيجة بعد.</div>
                <div style="margin-top:10px; display:flex; gap:8px">
                  <button id="exportDoc" class="btn">توليد مستند</button>
                  <button id="sendToJudge" class="btn secondary">إحالة إلى القاضي</button>
                </div>
              </div>
            </div>
          </article>

          <!-- Other panels (services, casefile, memo, sessions, judge, accessibility, security) are identical to previous implementation and remain unchanged. -->
          <!-- For brevity they are included in the same structure as earlier code; they will work with the same JS. -->
        </section>

        <!-- Right column -->
        <aside class="right-col">
          <div class="card"><h3>إجراءات سريعة</h3><div style="display:flex;flex-direction:column;gap:8px;margin-top:10px"><button class="btn" onclick="openPanel('casefile')">قيد دعوى</button><button class="btn secondary" onclick="openPanel('memo')">مذكرة</button><button class="btn secondary" onclick="openPanel('sessions')">جلسة</button></div></div>
          <div class="card"><h3>التكاملات</h3><p class="muted" style="margin-top:8px">OpenAI · Azure Speech · Google OCR · PKI · S3 · SSO</p><button class="btn secondary" onclick="alert('راجع إعدادات infra')">تفاصيل الربط</button></div>
          <div class="card"><h3>التواصل</h3><p class="muted" style="margin-top:8px">licensing@rawan.dev</p><button class="btn" onclick="location.href='mailto:licensing@rawan.dev'">اتصل</button></div>
        </aside>
      </div>

      <footer class="footer card" style="text-align:center">© 2026 روان الصبحي — جميع الحقوق محفوظة</footer>
    </main>
  </div>

  <!-- toast container -->
  <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

  <script>
    /****************************************************************
     * Interactive canvas background:
     * - draws diagonal "circuit" lines, particles, and floating binary digits
     * - subtle parallax based on mouse
     * - reduces workload on mobile / prefers-reduced-motion
     ****************************************************************/
    (function(){
      const canvas = document.getElementById('bgCanvas');
      const ctx = canvas.getContext('2d', { alpha: true });
      let DPR = Math.max(1, window.devicePixelRatio || 1);
      let w=0,h=0;
      let mouseX = 0, mouseY = 0, mouseActive=false;
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const isMobile = /Mobi|Android/i.test(navigator.userAgent);

      // config tuned for performance but rich visuals
      const config = {
        particles: isMobile ? 30 : 80,
        lines: 26,
        speed: isMobile ? 0.2 : 0.6,
        binaryDensity: isMobile ? 10 : 36,
        lineColor: { r: 12, g: 120, b: 86 }, // green hues
        glowAlpha: 0.06
      };

      function resize(){
        DPR = Math.max(1, window.devicePixelRatio || 1);
        w = canvas.width = Math.floor(window.innerWidth * DPR);
        h = canvas.height = Math.floor(window.innerHeight * DPR);
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        ctx.setTransform(DPR,0,0,DPR,0,0);
      }
      window.addEventListener('resize', resize, { passive: true });
      resize();

      // particles
      const particles = [];
      function initParticles(){
        particles.length = 0;
        for(let i=0;i<config.particles;i++){
          particles.push({
            x: Math.random()*window.innerWidth,
            y: Math.random()*window.innerHeight,
            r: Math.random()*2 + 0.6,
            vx: (Math.random()-0.5) * config.speed,
            vy: (Math.random()-0.5) * config.speed,
            alpha: 0.4 + Math.random()*0.6
          });
        }
      }

      // slanted circuit-like lines
      const slantedLines = [];
      function initLines(){
        slantedLines.length = 0;
        const spacing = window.innerWidth / config.lines;
        for(let i=-2;i<config.lines+2;i++){
          const base = i * spacing + (Math.random()*spacing*0.6 - spacing*0.3);
          slantedLines.push({
            baseX: base,
            offset: (Math.random()*40 - 20),
            segments: 6 + Math.floor(Math.random()*6),
            thickness: 0.6 + Math.random()*1.2
          });
        }
      }

      // binary glyphs drifting
      const binaries = [];
      function initBinaries(){
        binaries.length = 0;
        for(let i=0;i<config.binaryDensity;i++){
          binaries.push({
            x: Math.random()*window.innerWidth,
            y: Math.random()*window.innerHeight,
            v: 0.2 + Math.random()*0.6,
            char: Math.random() > 0.5 ? '0' : '1',
            alpha: 0.08 + Math.random()*0.22,
            size: 10 + Math.random()*10
          });
        }
      }

      function resetAll(){
        initParticles();
        initLines();
        initBinaries();
      }
      resetAll();

      // mouse parallax
      window.addEventListener('pointermove', (e) => {
        mouseX = e.clientX - window.innerWidth/2;
        mouseY = e.clientY - window.innerHeight/2;
        mouseActive = true;
      }, { passive: true });
      window.addEventListener('pointerout', ()=> mouseActive=false);

      // draw helpers
      function drawBackground(){
        // small gradient base already provided by CSS; we'll overlay circuitry
      }

      function drawLines(){
        ctx.save();
        ctx.lineCap = 'round';
        slantedLines.forEach((ln, idx) => {
          ctx.beginPath();
          // compute a slanted path across the screen
          const shift = (idx % 2 === 0) ? -1 : 1;
          const startX = ln.baseX + (mouseX * 0.02);
          const startY = -60 + ln.offset*0.3;
          const segLen = (window.innerHeight + 120) / ln.segments;
          let x = startX, y = startY;
          ctx.moveTo(x, y);
          for(let s=0;s<ln.segments;s++){
            x += shift * (8 + Math.sin((Date.now()*0.0006) + s) * 12) + (Math.cos(s*1.3 + idx)*6);
            y += segLen - (s*2);
            ctx.lineTo(x, y);
          }
          ctx.strokeStyle = `rgba(${config.lineColor.r},${config.lineColor.g},${config.lineColor.b},${0.06 + (idx%5)/50})`;
          ctx.lineWidth = ln.thickness;
          ctx.stroke();
          // bright highlights for some segments
          if(idx % 5 === 0){
            ctx.strokeStyle = `rgba(255,255,255,0.02)`;
            ctx.lineWidth = ln.thickness*0.4;
            ctx.stroke();
          }
        });
        ctx.restore();
      }

      function drawParticles(dt){
        ctx.save();
        particles.forEach(p => {
          p.x += p.vx * dt * 60;
          p.y += p.vy * dt * 60;
          // wrap
          if(p.x < -20) p.x = window.innerWidth + 20;
          if(p.x > window.innerWidth + 20) p.x = -20;
          if(p.y < -20) p.y = window.innerHeight + 20;
          if(p.y > window.innerHeight + 20) p.y = -20;

          // parallax shift
          const px = p.x + (mouseX * 0.02);
          const py = p.y + (mouseY * 0.02);

          const g = ctx.createRadialGradient(px, py, 0, px, py, p.r*8);
          g.addColorStop(0, `rgba(28,200,140,${p.alpha})`);
          g.addColorStop(0.4, `rgba(28,200,140,${p.alpha*0.18})`);
          g.addColorStop(1, `rgba(28,200,140,0)`);
          ctx.fillStyle = g;
          ctx.beginPath();
          ctx.arc(px, py, p.r*4, 0, Math.PI*2);
          ctx.fill();
        });
        ctx.restore();
      }

      function drawConnections(){
        // optional faint connections between close particles
        ctx.save();
        ctx.lineWidth = 0.6;
        for(let i=0;i<particles.length;i++){
          for(let j=i+1;j<particles.length;j++){
            const a = particles[i], b = particles[j];
            const dx = a.x - b.x, dy = a.y - b.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist < 140){
              const alpha = (1 - dist/140) * 0.06;
              ctx.strokeStyle = `rgba(${config.lineColor.r},${config.lineColor.g},${config.lineColor.b},${alpha})`;
              ctx.beginPath();
              ctx.moveTo(a.x + mouseX*0.01, a.y + mouseY*0.01);
              ctx.lineTo(b.x + mouseX*0.01, b.y + mouseY*0.01);
              ctx.stroke();
            }
          }
        }
        ctx.restore();
      }

      function drawBinary(dt){
        ctx.save();
        ctx.fillStyle = `rgba(200,255,220,0.08)`;
        ctx.font = '10px Cairo, monospace';
        binaries.forEach(b => {
          b.y += b.v * dt * 60;
          if(b.y > window.innerHeight + 20) { b.y = -20; b.x = Math.random()*window.innerWidth; b.char = Math.random()>0.5?'0':'1'; }
          ctx.globalAlpha = b.alpha;
          ctx.fillStyle = `rgba(160,255,200,${b.alpha})`;
          ctx.fillText(b.char, b.x + mouseX*0.008, b.y + mouseY*0.008);
        });
        ctx.restore();
      }

      // animation loop
      let last = performance.now();
      function tick(now){
        const dt = Math.min(0.06, (now - last) / 1000); // cap dt
        last = now;

        // clear with translucent fill to create motion trails
        ctx.clearRect(0,0,canvas.width, canvas.height);
        // overlay faint vignette
        ctx.fillStyle = 'rgba(0,8,7,0.14)';
        ctx.fillRect(0,0,window.innerWidth, window.innerHeight);

        // draw slanted circuit lines
        drawLines();

        // particles & connections
        drawParticles(dt);
        drawConnections();

        // binary glyphs
        drawBinary(dt);

        // glow layer to hint circuitry
        ctx.save();
        ctx.globalCompositeOperation = 'lighter';
        ctx.fillStyle = `rgba(${config.lineColor.r},${config.lineColor.g},${config.lineColor.b},${config.glowAlpha})`;
        ctx.fillRect(0,0,window.innerWidth, window.innerHeight);
        ctx.restore();

        if(!prefersReduced) requestAnimationFrame(tick);
      }

      // start or stop depending on preference
      if(prefersReduced){
        // static render
        drawLines(); drawParticles(0.016); drawBinary(0.016);
      } else {
        requestAnimationFrame(tick);
      }

      // re-init when resizing large changes
      let resizeDeb;
      window.addEventListener('resize', ()=> {
        clearTimeout(resizeDeb);
        resizeDeb = setTimeout(()=> {
          resize(); resetAll();
        }, 180);
      });

      // expose simple API for debugging
      window._bg = { resetAll };
    })();

    /****************************************************************
     * UI interactivity (buttons, panels, uploader, AI) - kept minimal
     * Uses same endpoints described earlier (/api/...)
     ****************************************************************/
    (function(){
      // helper selectors
      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
      const showToast = (msg, type='default', ttl=3000) => {
        const wrap = document.getElementById('toastWrap');
        const t = document.createElement('div'); t.className = 'toast';
        t.innerText = msg; wrap.appendChild(t);
        requestAnimationFrame(()=> t.classList.add('show'));
        setTimeout(()=> { t.classList.remove('show'); setTimeout(()=> t.remove(), 300); }, ttl);
      };

      // Panel navigation
      $$('nav.menu button').forEach(btn=>{
        btn.addEventListener('click', ()=> {
          $$('nav.menu button').forEach(b=> b.classList.remove('active'));
          btn.classList.add('active');
          openPanel(btn.dataset.panel);
        });
      });
      function openPanel(name){
        const map = { assistant:'panel-assistant', services:'panel-services', casefile:'panel-casefile', memo:'panel-memo', sessions:'panel-sessions', judgeboard:'panel-judgeboard', accessibility:'panel-accessibility', security:'panel-security' };
        Object.values(map).forEach(id => { const el = document.getElementById(id); if(el) el.hidden = true; });
        const id = map[name] || ('panel-' + name);
        const el = document.getElementById(id);
        if(el) el.hidden = false;
        window.scrollTo({ top: 0, behavior:'smooth' });
      }
      openPanel('assistant');

      // uploader setup (presign + PUT)
      function setupUploader(elId, progressId){
        const el = document.getElementById(elId), progress = document.getElementById(progressId);
        el.addEventListener('click', ()=> {
          const inp = document.createElement('input'); inp.type='file'; inp.multiple=true;
          inp.onchange = ()=> handleFiles(inp.files, progress);
          inp.click();
        });
        ['dragenter','dragover'].forEach(ev => el.addEventListener(ev, e => { e.preventDefault(); el.style.borderColor = '#0fb06b'; }));
        ['dragleave','drop'].forEach(ev => el.addEventListener(ev, e => { e.preventDefault(); el.style.borderColor = ''; if(e.type==='drop') handleFiles(e.dataTransfer.files, progress); }));
      }
      async function presign(filename, contentType){
        const res = await fetch('/api/upload/presign', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ filename, contentType })});
        if(!res.ok) throw new Error('presign failed');
        return await res.json();
      }
      async function uploadToUrl(url, file){
        const res = await fetch(url, { method:'PUT', body: file, headers:{ 'Content-Type': file.type }});
        if(!res.ok) throw new Error('upload failed');
        return true;
      }
      async function handleFiles(files, progressEl){
        if(!files || files.length === 0) return;
        progressEl.style.display = 'block';
        const bar = progressEl.querySelector('i'); bar.style.width = '0%';
        try {
          for(let i=0;i<files.length;i++){
            const f = files[i];
            const pre = await presign(f.name, f.type || 'application/octet-stream');
            await uploadToUrl(pre.url, f);
            bar.style.width = `${Math.round(((i+1)/files.length)*100)}%`;
          }
          setTimeout(()=> { progressEl.style.display = 'none'; bar.style.width='0%'; showToast('تم رفع الملفات', 'success'); }, 400);
        } catch(err){
          progressEl.style.display = 'none'; bar.style.width='0%'; showToast('فشل الرفع: ' + err.message, 'default');
        }
      }
      setupUploader('uploader','uploadProgress');
      setupUploader('caseUploader','uploadProgress');

      // AI analyze click
      $('#runAi').addEventListener('click', async ()=> {
        const text = $('#facts').value.trim();
        if(!text) return showToast('اكتب ملخص الوقائع قبل التشغيل', 'default');
        const resultBlock = $('#aiResult'), content = $('#analysisContent'), spinner = $('#analysisSpinner');
        resultBlock.style.display = 'block'; spinner.style.display = 'inline-block'; $('#runAi').setAttribute('aria-busy','true'); showToast('جارِ التحليل ...', 'default', 1500);
        try {
          const res = await fetch('/api/ai/analyze', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ text })});
          if(!res.ok) throw new Error('AI call failed');
          const json = await res.json();
          spinner.style.display = 'none'; $('#runAi').setAttribute('aria-busy','false'); showToast('اكتمل التحليل', 'default', 1500);
          if(json.raw) content.innerText = json.raw;
          else if(json.verdict) content.innerHTML = `<strong>${json.verdict}</strong><ul style="margin:8px 0 0 0;padding-inline-start:18px">${(json.issues||[]).map(i=>`<li>${i}</li>`).join('')}</ul><div style="margin-top:8px"><strong>توصيات:</strong><ol style="margin:6px 0 0 0;padding-inline-start:18px">${(json.recommendations||[]).map(r=>`<li>${r}</li>`).join('')}</ol></div>`;
          else content.innerText = JSON.stringify(json, null, 2);
        } catch(err){ spinner.style.display='none'; $('#runAi').setAttribute('aria-busy','false'); content.textContent = 'خطأ: ' + err.message; showToast('خطأ في تحليل AI', 'default'); }
      });

      // case submit
      $('#submitCase').addEventListener('click', async ()=> {
        const plaintiff = $('#plaintiff').value.trim(), subject = $('#subject').value.trim(), details = $('#details').value.trim();
        const fb = $('#caseFeedback'); if(!plaintiff||!subject||!details){ fb.style.display='block'; fb.textContent='يرجى ملء الحقول'; return; }
        fb.style.display='block'; fb.textContent='جاري الإرسال...';
        try {
          const res = await fetch('/api/cases', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ plaintiff, subject, details, attachments: [] })});
          if(!res.ok) throw new Error('create case failed');
          const data = await res.json(); fb.textContent = 'تم قيد الدعوى: ' + data.id; showToast('تم قيد الدعوى', 'default');
        } catch(err){ fb.textContent = 'فشل: ' + err.message; showToast('خطأ في القيد', 'default'); }
      });

      // memos
      async function loadMemos(){
        try {
          const res = await fetch('/api/memos'); if(!res.ok) throw new Error('failed');
          const list = await res.json();
          $('#memoList').innerHTML = list.map(m => `<li><strong>${m.from}</strong> — ${m.time? new Date(m.time).toLocaleString():''}<div style="font-size:13px;color:var(--muted);margin-top:6px">${m.text}</div></li>`).join('');
        } catch(e){ $('#memoList').innerHTML = '<li class="muted">تعذر التحميل</li>'; }
      }
      loadMemos();
      $('#sendMemo').addEventListener('click', async ()=> {
        const text = $('#memoText').value.trim(); if(!text) return showToast('اكتب المذكرة', 'default');
        const res = await fetch('/api/memos', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ text, from:'أنت' })});
        if(!res.ok) return showToast('فشل الإرسال', 'default');
        $('#memoText').value=''; loadMemos(); showToast('تم الإرسال', 'default');
      });

      // sessions
      $('#createSession').addEventListener('click', async ()=> {
        const subj = $('#sessionSubj').value.trim(), datetime = $('#sessionDate').value;
        if(!subj || !datetime) return showToast('ادخل الموضوع والتاريخ', 'default');
        const res = await fetch('/api/sessions', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ subj, datetime })});
        if(!res.ok) return showToast('فشل إنشاء الجلسة', 'default');
        const s = await res.json(); renderSessions([s, ...(window._sessions||[]) ]); showToast('تم إنشاء الجلسة', 'default');
      });
      function renderSessions(list){ window._sessions = list; $('#sessionList').innerHTML = list.map(s => `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"><strong>${s.subj}</strong><div class="muted">${new Date(s.datetime).toLocaleString()}</div><a href="${s.link}" target="_blank">${s.link}</a></div>`).join(''); }

      // judge chart
      (function(){ const ctx = document.getElementById('judgeChart'); if(!ctx) return; new Chart(ctx, { type:'doughnut', data:{ labels:['منجز','قيد','نواقص'], datasets:[{ data:[1420,85,12], backgroundColor:['#FFB703','#0fb06b','#ff6b6b'] }] }, options:{plugins:{legend:{position:'bottom'}}} ); $('#todayCases').textContent = 'قضايا: 27 — عاجلة: 3'; })();

      // accessibility (TTS/STT)
      $('#enableTTS').addEventListener('click', ()=> { const text = $('#analysisContent').innerText || 'لا توجد نتائج'; if('speechSynthesis' in window){ const u = new SpeechSynthesisUtterance(text); u.lang='ar-SA'; speechSynthesis.speak(u); showToast('تشغيل القراءة', 'default'); } else showToast('TTS غير متاح', 'default'); });
      $('#startSTT').addEventListener('click', ()=> { if(!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) return showToast('STT غير مدعوم', 'default'); const SR = window.SpeechRecognition || window.webkitSpeechRecognition; const r = new SR(); r.lang='ar-SA'; r.interimResults=true; r.onresult = e => { $('#facts').value = Array.from(e.results).map(r=>r[0].transcript).join(''); }; r.onerror = ()=> showToast('خطأ STT', 'default'); r.start(); });

      // theme toggle (simple)
      $('#themeToggle').addEventListener('click', ()=> { const root = document.documentElement; if(getComputedStyle(root).getPropertyValue('--bg-1') === '#071018'){ root.style.setProperty('--bg-1','#071918'); root.style.setProperty('--bg-2','#042a24'); showToast('سمة التقنية الفاتحة', 'default'); } else { root.style.setProperty('--bg-1','#071918'); root.style.setProperty('--bg-2','#042a24'); showToast('سمة تقنية', 'default'); } });

      // initial small motion on logo
      const logo = document.getElementById('brandLogo'); logo.addEventListener('mouseenter', ()=> logo.style.transform = 'translateY(-6px) scale(1.02)'); logo.addEventListener('mouseleave', ()=> logo.style.transform = '');

      // keyboard shortcuts
      window.addEventListener('keydown', e => { if(e.key==='1') openPanel('assistant'); if(e.key==='2') openPanel('services'); if(e.key==='3') openPanel('casefile'); if(e.key==='4') openPanel('memo'); if(e.key==='5') openPanel('sessions'); if(e.key==='6') openPanel('judgeboard'); });
    })();
  </script>
</body>
</html>
