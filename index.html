<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>رواق العدل — المنصة المتكاملة</title>

  <!-- خطوط وأيقونات -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <meta name="description" content="رواق العدل — منصة قضائية متكاملة" />
  <meta name="author" content="روان الصبحي" />

  <style>
    :root{
      --bg-1:#071918;
      --bg-2:#042a24;
      --muted:#93a79f;
      --green:#0fb06b;
      --gold:#FFB703;
      --card-radius:14px;
      --glass: rgba(255,255,255,0.03);
      --max-width:1200px;
      --ui-ease: cubic-bezier(.2,.9,.2,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Cairo',sans-serif;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#e6fff4;-webkit-font-smoothing:antialiased}
    a{color:var(--green)}
    img{max-width:100%;height:auto}

    /* canvas background */
    #bgCanvas{position:fixed;inset:0;width:100vw;height:100vh;z-index:-2;background:linear-gradient(180deg, rgba(2,18,16,0.95), rgba(3,28,24,0.98))}
    .bg-overlay{position:fixed;inset:0;z-index:-1;background:linear-gradient(180deg, rgba(0,15,12,0.35), rgba(0,10,8,0.55));mix-blend-mode:overlay;pointer-events:none}

    /* container */
    .app{max-width:var(--max-width);margin:18px auto;padding:12px;display:grid;grid-template-columns:320px 1fr;gap:16px;position:relative;z-index:0}
    @media (max-width:1000px){ .app{grid-template-columns:1fr;padding:10px} }

    /* sidebar */
    .sidebar{background:var(--glass);border-radius:var(--card-radius);padding:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 18px 48px rgba(0,0,0,0.55);backdrop-filter:blur(8px)}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:72px;height:72px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--green), #0b7d56);box-shadow:0 10px 30px rgba(0,0,0,0.5);cursor:pointer}
    .brand h1{margin:0;font-size:18px;color:#eaffef;font-weight:800}
    .brand p{margin:0;color:var(--muted);font-size:13px}

    nav.menu{margin-top:12px;display:flex;flex-direction:column;gap:8px}
    .menu button{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-weight:700;text-align:right}
    .menu button .ico{width:36px;height:36;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.04)}
    .menu button.active{background:linear-gradient(90deg, rgba(15,176,107,0.06), rgba(255,255,255,0.02));border-left:4px solid var(--gold);color:#eaffef}

    .sidebar .foot{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

    /* main */
    .main{display:flex;flex-direction:column;gap:12px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .search{flex:1;display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04)}
    .search input{border:0;background:transparent;outline:none;padding:6px 8px;font-size:14px;color:#eafff0;width:100%}
    .controls{display:flex;gap:8px;align-items:center}

    .layout-grid{display:grid;grid-template-columns:1fr 380px;gap:14px}
    @media (max-width:980px){ .layout-grid{grid-template-columns:1fr} }

    .card{border-radius:12px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 36px rgba(0,0,0,0.5);backdrop-filter:blur(6px)}

    h2{margin:0 0 8px 0;color:var(--green)}
    h3{margin:0 0 8px 0;color:var(--gold)}
    .muted{color:var(--muted);font-size:13px}

    /* inputs (glass) */
    .input, textarea, select { width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background: rgba(0,0,0,0.16); color:#eafff0; outline:none; transition:box-shadow .12s, transform .12s }
    textarea{min-height:120px;resize:vertical}
    .input:focus, textarea:focus{ box-shadow:0 12px 30px rgba(15,176,107,0.06); transform:translateY(-2px); border-color: rgba(15,176,107,0.18); }

    .btn{display:inline-flex;align-items:center;gap:8px; background:linear-gradient(180deg,var(--gold), #d59b03); color:#071018; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800}
    .btn.secondary{background:transparent;color:var(--gold);border:1px solid rgba(255,255,255,0.04)}

    .uploader{border:2px dashed rgba(255,255,255,0.03);padding:12px;border-radius:10px;text-align:center;color:var(--muted);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));cursor:pointer}

    .services-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
    .service{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);cursor:pointer}

    .list{list-style:none;padding:0;margin:0}
    .list li{padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.03);color:var(--muted)}

    .responsive-mobile-menu{display:none}
    @media (max-width:700px){
      .menu{display:none}
      .responsive-mobile-menu{display:block;margin-bottom:8px}
    }

    .toast-wrap{position:fixed;left:50%;transform:translateX(-50%);top:18px;z-index:2000}
    .toast{background:rgba(0,0,0,0.7);color:#fff;padding:10px 14px;border-radius:8px;margin-bottom:8px;opacity:0;transform:translateY(-8px);transition:all .28s}

    /* small helpers */
    .row{display:flex;gap:8px;align-items:flex-end}
    .col{flex:1}
    :focus{outline:3px solid rgba(15,176,107,0.08);outline-offset:2px}
  </style>
</head>
<body>
  <!-- interactive canvas bg -->
  <canvas id="bgCanvas" aria-hidden="true"></canvas>
  <div class="bg-overlay" aria-hidden="true"></div>

  <div class="app" role="application" aria-label="رواق العدل — المنصة المتكاملة">
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="الشريط الجانبي">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="brand" role="img" aria-label="شعار رواق العدل">
          <div class="logo" id="brandLogo" tabindex="0" title="رواق العدل — الشعار الرسمي">
            <!-- inline SVG (sword/palm/scale) -->
            <svg viewBox="0 0 120 120" width="56" height="56" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <defs>
                <linearGradient id="g-green" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#2aa05a"/><stop offset="1" stop-color="#116938"/></linearGradient>
                <linearGradient id="g-gold" x1="0" x2="1"><stop offset="0" stop-color="#fff0b8"/><stop offset="1" stop-color="#FFB703"/></linearGradient>
              </defs>
              <g transform="translate(60,62)" opacity="0.96">
                <g transform="rotate(-28)"><rect x="-1.6" y="-48" width="3.2" height="92" rx="0.9" fill="#dcdcdc"/><rect x="-7" y="36" width="14" height="4.4" rx="1.1" fill="#b28627"/></g>
                <g transform="rotate(28)"><rect x="-1.6" y="-48" width="3.2" height="92" rx="0.9" fill="#dcdcdc"/><rect x="-7" y="36" width="14" height="4.4" rx="1.1" fill="#b28627"/></g>
              </g>
              <g transform="translate(60,36)" opacity="0.98">
                <rect x="-3.2" y="8" width="6.4" height="30" rx="1.2" fill="url(#g-green)" />
              </g>
              <g transform="translate(60,48)">
                <rect x="-2.8" y="2" width="5.6" height="36" rx="1.4" fill="#cfcfcf"/>
                <g transform="translate(0,10)"><rect x="-30" y="-3.6" width="60" height="7.2" rx="3.6" fill="url(#g-gold)"/></g>
              </g>
            </svg>
          </div>
          <div>
            <h1>رواق العدل</h1>
            <p class="muted">منصة قضائية متكاملة</p>
          </div>
        </div>

        <!-- mobile menu toggle -->
        <button class="btn secondary responsive-mobile-menu" id="mobileMenuBtn" aria-expanded="false" aria-controls="mobileMenu">القائمة</button>
      </div>

      <nav class="menu" role="navigation" aria-label="قائمة الخدمات" id="desktopMenu">
        <button class="active" data-panel="assistant"><span class="ico"><i class="fa-solid fa-brain"></i></span>المساعد الذكي</button>
        <button data-panel="services"><span class="ico"><i class="fa-solid fa-layer-group"></i></span>الخدمات الشاملة</button>
        <button data-panel="casefile"><span class="ico"><i class="fa-solid fa-file-circle-plus"></i></span>قيد دعوى</button>
        <button data-panel="memo"><span class="ico"><i class="fa-solid fa-file-lines"></i></span>تبادل مذكرات</button>
        <button data-panel="sessions"><span class="ico"><i class="fa-solid fa-video"></i></span>جلسات رقمية</button>
        <button data-panel="judgeboard"><span class="ico"><i class="fa-solid fa-balance-scale"></i></span>منصة القاضي</button>
        <button data-panel="accessibility"><span class="ico"><i class="fa-solid fa-universal-access"></i></span>الوصول</button>
        <button data-panel="security"><span class="ico"><i class="fa-solid fa-shield"></i></span>الأمن</button>
      </nav>

      <div class="foot">روان الصبحي — © 2026<br><a href="./LICENSE">شروط الترخيص</a></div>
    </aside>

    <!-- MAIN -->
    <main class="main" role="main">
      <div class="topbar">
        <div class="search" role="search">
          <i class="fa-solid fa-magnifying-glass" style="color:var(--muted)"></i>
          <input id="unifiedSearch" placeholder="استعلام موحّد: رقم قضية، اسم، قرار..." aria-label="استعلام موحّد">
        </div>

        <div class="controls">
          <button id="themeToggle" class="btn secondary" title="تبديل السمة">سمة</button>
          <button id="userBtn" class="btn secondary" title="المحكمة الإلكترونية">حساب</button>
        </div>
      </div>

      <div class="layout-grid">
        <!-- LEFT: panels -->
        <section id="panels" style="min-height:560px">
          <!-- ASSISTANT -->
          <article id="panel-assistant" class="card" role="region" aria-labelledby="assistantTitle">
            <h2 id="assistantTitle">المساعد الذكي — تدقيق وتحليل</h2>
            <p class="muted">ارفع المستندات أو اكتب ملخص الوقائع. سيولد المساعد نقاط نواقص، توصيات، ومسودات.</p>

            <label class="muted" for="facts">ملخص الوقائع</label>
            <textarea id="facts" class="input" placeholder="اكتب ملخص الوقائع..." aria-label="ملخص الوقائع"></textarea>

            <div style="display:flex;gap:10px;margin-top:10px;align-items:flex-start">
              <div style="flex:1">
                <div id="uploader" class="uploader" tabindex="0">اسحب الملفات هنا أو اضغط للاختيار (PDF/صور)</div>
                <div id="uploadProgress" class="progress" style="display:none;margin-top:8px"><i style="width:0%"></i></div>
              </div>

              <div style="width:200px;display:flex;flex-direction:column;gap:8px">
                <button id="runAi" class="btn" aria-live="polite">تشغيل التدقيق الذكي</button>
                <button id="exportDraft" class="btn secondary">توليد مسودة</button>
                <button id="sendToJudge" class="btn secondary">إحالة للقاضي</button>
              </div>
            </div>

            <div id="aiResult" style="margin-top:12px;display:none">
              <div class="card">
                <h3>نتيجة التحليل</h3>
                <div id="analysisContent" class="muted">لا توجد نتيجة بعد.</div>
              </div>
            </div>
          </article>

          <!-- SERVICES -->
          <article id="panel-services" class="card" role="region" aria-labelledby="servicesTitle" hidden>
            <h2 id="servicesTitle">الخدمات الشاملة</h2>
            <p class="muted">مجموعة متكاملة من الخدمات لكل دورة قضائية — متصلة بالمساعد الذكي وعمليات الأرشفة والتوقيع.</p>

            <div class="services-grid" style="margin-top:10px">
              <div class="service" data-service="casefile">
                <h4>قيد دعوى إلكتروني</h4>
                <p class="muted">نموذج كامل، تحقق آلي من المرفقات، وتوليد إشعارات.</p>
                <div style="margin-top:8px"><button class="btn" onclick="openPanel('casefile')">افتح</button></div>
              </div>

              <div class="service" data-service="memo">
                <h4>تبادل مذكرات</h4>
                <p class="muted">صندوق وارد وصادر، توقيع PKI وخيارات تتبع.</p>
                <div style="margin-top:8px"><button class="btn" onclick="openPanel('memo')">افتح</button></div>
              </div>

              <div class="service" data-service="sessions">
                <h4>جلسات رقمية</h4>
                <p class="muted">حجز، روابط مؤمنة، تفريغ صوتي وتخزين محمي.</p>
                <div style="margin-top:8px"><button class="btn" onclick="openPanel('sessions')">افتح</button></div>
              </div>

              <div class="service" data-service="access">
                <h4>الوصول</h4>
                <p class="muted">TTS, STT, Live Captions، وسمات وصول متقدمة.</p>
                <div style="margin-top:8px"><button class="btn" onclick="openPanel('accessibility')">افتح</button></div>
              </div>

              <div class="service" data-service="archive">
                <h4>أرشفة موثقة</h4>
                <p class="muted">حفظ آمن، نسخ مع توقيت زمني ومراجعة سلامة.</p>
              </div>

              <div class="service" data-service="analytics">
                <h4>تقارير وتحليلات</h4>
                <p class="muted">لوحات أداء، مؤشرات ومخرجات AI للقضاة.</p>
              </div>
            </div>
          </article>

          <!-- CASE FILING -->
          <article id="panel-casefile" class="card" role="region" aria-labelledby="casefileTitle" hidden>
            <h2 id="casefileTitle">قيد دعوى جديد</h2>
            <p class="muted">املأ النموذج وإرفاق المستندات — سيتم التحقق آلياً.</p>

            <form id="caseForm" onsubmit="return false" style="margin-top:10px">
              <div class="row">
                <div class="col"><label class="muted">اسم المدعي</label><input id="plaintiff" class="input" required></div>
                <div style="width:160px"><label class="muted">رقم مرجعي</label><input id="caseRef" class="input"></div>
              </div>

              <div style="margin-top:10px"><label class="muted">موضوع</label><input id="caseSubject" class="input" required></div>
              <div style="margin-top:10px"><label class="muted">تفاصيل</label><textarea id="caseDetails" class="input" required></textarea></div>

              <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
                <div style="flex:1"><div id="caseUploader" class="uploader">اسحب مستندات الدعوى أو اضغط للاختيار</div></div>
                <div style="width:160px"><button id="submitCase" class="btn">قيد الدعوى</button></div>
              </div>

              <div id="caseFeedback" class="muted" style="margin-top:8px;display:none"></div>
            </form>

            <div style="margin-top:12px">
              <h3>قضايا حديثة</h3>
              <ul id="casesList" class="list"></ul>
            </div>
          </article>

          <!-- MEMOS -->
          <article id="panel-memo" class="card" role="region" aria-labelledby="memoTitle" hidden>
            <h2 id="memoTitle">تبادل مذكرات</h2>
            <div style="display:flex;gap:12px;margin-top:10px">
              <div style="flex:1">
                <h4 class="muted">الوارد / الصادر</h4>
                <ul id="memoList" class="list" style="max-height:340px;overflow:auto"></ul>
              </div>
              <div style="width:320px">
                <label class="muted">مذكرة جديدة</label>
                <textarea id="memoText" class="input"></textarea>
                <button id="sendMemo" class="btn" style="margin-top:8px">إرسال</button>
              </div>
            </div>
          </article>

          <!-- SESSIONS -->
          <article id="panel-sessions" class="card" role="region" aria-labelledby="sessionsTitle" hidden>
            <h2 id="sessionsTitle">جلسات رقمية</h2>
            <div style="margin-top:10px">
              <label class="muted">موضوع الجلسة</label>
              <input id="sessionSubj" class="input">
              <div class="row" style="margin-top:8px">
                <div class="col"><label class="muted">التاريخ والوقت</label><input id="sessionDate" type="datetime-local" class="input"></div>
                <div style="width:150px"><button id="createSession" class="btn">إنشاء جلسة</button></div>
              </div>

              <div style="margin-top:12px">
                <h4 class="muted">الجلسات القادمة</h4>
                <div id="sessionList" style="max-height:260px;overflow:auto"></div>
              </div>
            </div>
          </article>

          <!-- JUDGE BOARD -->
          <article id="panel-judgeboard" class="card" role="region" aria-labelledby="judgeTitle" hidden>
            <h2 id="judgeTitle">منصة القاضي</h2>
            <p class="muted">لوحة قرارات تعرض أولويات القضايا وتنبيهات الذكاء الاصطناعي.</p>

            <div style="display:flex;gap:12px;margin-top:12px">
              <div style="flex:1" class="card">
                <h3>قضايا اليوم</h3>
                <div id="judgeCases" class="muted">جاري التحميل...</div>
              </div>
              <div style="width:320px" class="card">
                <h3>مخطط الحالة</h3>
                <canvas id="judgeChart" style="max-height:160px"></canvas>
              </div>
            </div>
          </article>

          <!-- ACCESSIBILITY -->
          <article id="panel-accessibility" class="card" role="region" aria-labelledby="accessTitle" hidden>
            <h2 id="accessTitle">الوصول</h2>
            <p class="muted">TTS, STT, تسميات فورية، وضع خطي للقراءة، وتوافق لوحة المفاتيح.</p>

            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="enableTTS" class="btn">تشغيل قراءة النتائج</button>
              <button id="enableCaptions" class="btn secondary">عرض التسمية الحية</button>
              <button id="startSTT" class="btn secondary">تشغيل أوامر صوتية</button>
            </div>
          </article>

          <!-- SECURITY -->
          <article id="panel-security" class="card" role="region" aria-labelledby="securityTitle" hidden>
            <h2 id="securityTitle">الأمن والامتثال</h2>
            <p class="muted">PKI، توقيع رقمي، SSO، تشفير، وسجلات تدقيق قابلة للتصدير.</p>

            <ul class="muted" style="margin-top:8px">
              <li>تشفير TLS وحقول حساسة مشفرة داخل DB</li>
              <li>SSO / OIDC / SAML وMFA</li>
              <li>سجل تدقيق لكل إجراء (Audit Logs)</li>
            </ul>
          </article>
        </section>

        <!-- RIGHT column -->
        <aside>
          <div class="card">
            <h3>إجراءات سريعة</h3>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
              <button class="btn" onclick="openPanel('casefile')">قيد دعوى</button>
              <button class="btn secondary" onclick="openPanel('memo')">مذكرة</button>
              <button class="btn secondary" onclick="openPanel('sessions')">جدولة جلسة</button>
            </div>
          </div>

          <div class="card">
            <h3>التكاملات</h3>
            <p class="muted" style="margin-top:8px">OpenAI · Azure Speech · Google OCR · PKI/HSM · S3 · SSO</p>
            <button class="btn secondary" onclick="alert('تفاصيل الربط: راجع مستند infra')">تفاصيل الربط</button>
          </div>

          <div class="card">
            <h3>التواصل</h3>
            <p class="muted" style="margin-top:8px">licensing@rawan.dev</p>
            <button class="btn" onclick="location.href='mailto:licensing@rawan.dev'">اتصل</button>
          </div>
        </aside>
      </div>

      <footer style="text-align:center;color:var(--muted);margin-top:10px">© 2026 روان الصبحي — جميع الحقوق محفوظة</footer>
    </main>
  </div>

  <div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

  <script>
    /* ---------------------------
       Background particle engine
       (uses your provided code, enhanced)
       --------------------------- */
    (function(){
      const canvas = document.getElementById('bgCanvas');
      const ctx = canvas.getContext('2d', { alpha: true });
      const DPR = Math.max(1, window.devicePixelRatio || 1);
      function resizeCanvas(){
        canvas.width = Math.floor(window.innerWidth * DPR);
        canvas.height = Math.floor(window.innerHeight * DPR);
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        ctx.setTransform(DPR,0,0,DPR,0,0);
      }
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      class Particle {
        constructor(){
          this.x = Math.random() * window.innerWidth;
          this.y = Math.random() * window.innerHeight;
          this.speedX = Math.random()*0.6 - 0.3;
          this.speedY = Math.random()*0.6 - 0.3;
          this.size = Math.random()*2 + 0.6;
        }
        update(){
          this.x += this.speedX;
          this.y += this.speedY;
          if(this.x < -20) this.x = window.innerWidth+20;
          if(this.x > window.innerWidth+20) this.x = -20;
          if(this.y < -20) this.y = window.innerHeight+20;
          if(this.y > window.innerHeight+20) this.y = -20;
        }
        draw(){
          ctx.beginPath();
          ctx.fillStyle = 'rgba(15,176,107,0.36)';
          ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
          ctx.fill();
        }
      }

      let particles = [];
      function initParticles(n=80){
        particles = [];
        for(let i=0;i<n;i++) particles.push(new Particle());
      }
      initParticles( isMobile()? 40 : 90 );

      function isMobile(){ return /Mobi|Android/i.test(navigator.userAgent); }

      function drawConnections(){
        for(let i=0;i<particles.length;i++){
          for(let j=i+1;j<particles.length;j++){
            const a = particles[i], b = particles[j];
            const dx = a.x - b.x, dy = a.y - b.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist < 120){
              const alpha = Math.max(0.02, 0.15 - dist/800);
              ctx.strokeStyle = `rgba(15,176,107,${alpha})`;
              ctx.lineWidth = 0.45;
              ctx.beginPath();
              ctx.moveTo(a.x,a.y);
              ctx.lineTo(b.x,b.y);
              ctx.stroke();
            }
          }
        }
      }

      function frame(){
        ctx.fillStyle = 'rgba(0,8,7,0.16)';
        ctx.fillRect(0,0,window.innerWidth, window.innerHeight);
        particles.forEach(p=> { p.update(); p.draw(); });
        drawConnections();
        requestAnimationFrame(frame);
      }
      frame();

      // re-init on resize
      let rt;
      window.addEventListener('resize', ()=> { clearTimeout(rt); rt=setTimeout(()=> initParticles(isMobile()?40:90),150); });
    })();

    /* ---------------------------
       UI logic: panels, CRUD (localStorage fallback), fetch to backend when available
       - Cases, Memos, Sessions managed locally and synced to backend if endpoints exist.
       --------------------------- */
    (function(){
      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const toastWrap = document.getElementById('toastWrap');
      function toast(msg, ttl=3000){ const el = document.createElement('div'); el.className='toast'; el.textContent = msg; toastWrap.appendChild(el); requestAnimationFrame(()=> el.style.opacity=1 ); setTimeout(()=> { el.style.opacity=0; setTimeout(()=> el.remove(), 300); }, ttl); }

      // local stores
      const store = {
        cases: JSON.parse(localStorage.getItem('rwaq_cases')||'[]'),
        memos: JSON.parse(localStorage.getItem('rwaq_memos')||'[]'),
        sessions: JSON.parse(localStorage.getItem('rwaq_sessions')||'[]')
      };

      function saveStore(){ localStorage.setItem('rwaq_cases', JSON.stringify(store.cases)); localStorage.setItem('rwaq_memos', JSON.stringify(store.memos)); localStorage.setItem('rwaq_sessions', JSON.stringify(store.sessions)); }

      // Panel navigation
      $$('.menu button').forEach(btn=>{
        btn.addEventListener('click', ()=> {
          $$('.menu button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          openPanel(btn.dataset.panel);
          if(window.innerWidth < 700) window.scrollTo({top:0, behavior:'smooth'});
        });
      });
      function openPanel(name){
        const map = {
          assistant:'panel-assistant', services:'panel-services', casefile:'panel-casefile', memo:'panel-memo',
          sessions:'panel-sessions', judgeboard:'panel-judgeboard', accessibility:'panel-accessibility', security:'panel-security'
        };
        Object.values(map).forEach(id => { const el=document.getElementById(id); if(el) el.hidden = true; });
        const id = map[name] || ('panel-'+name);
        const el = document.getElementById(id); if(el) el.hidden = false;
      }
      openPanel('assistant');

      // Mobile menu toggle
      const mobileBtn = document.getElementById('mobileMenuBtn');
      mobileBtn && mobileBtn.addEventListener('click', ()=>{
        const menu = document.querySelector('nav.menu');
        if(menu.style.display === 'flex'){ menu.style.display = 'none'; mobileBtn.setAttribute('aria-expanded','false'); }
        else { menu.style.display = 'flex'; mobileBtn.setAttribute('aria-expanded','true'); }
      });

      // Uploader (presign -> PUT) with graceful fallback (local simulate)
      function setupUploader(elId, progressId){
        const el = document.getElementById(elId), progress = document.getElementById(progressId);
        el.addEventListener('click', ()=> {
          const inp = document.createElement('input'); inp.type='file'; inp.multiple=true;
          inp.onchange = ()=> handleFiles(inp.files, progress);
          inp.click();
        });
        ['dragenter','dragover'].forEach(e=> el.addEventListener(e, ev=> { ev.preventDefault(); el.style.borderColor='#0fb06b'; }));
        ['dragleave','drop'].forEach(e=> el.addEventListener(e, ev=> { ev.preventDefault(); el.style.borderColor=''; if(ev.type==='drop') handleFiles(ev.dataTransfer.files, progress); }));
      }

      async function presign(filename, contentType){
        try {
          const res = await fetch('/api/upload/presign', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ filename, contentType }) });
          if(!res.ok) throw new Error('presign not available');
          return await res.json();
        } catch(e){
          // fallback: return fake URL and key
          return { url: null, key: 'local/' + Date.now() + '-' + filename, bucket: 'local' };
        }
      }
      async function uploadToUrl(url, file){
        if(!url) return true; // in fallback case we treat as success
        const res = await fetch(url, { method:'PUT', body: file, headers:{ 'Content-Type': file.type }});
        if(!res.ok) throw new Error('upload failed');
        return true;
      }

      async function handleFiles(files, progressEl){
        if(!files || files.length===0) return;
        progressEl.style.display='block';
        const bar = progressEl.querySelector('i'); bar.style.width='0%';
        try {
          for(let i=0;i<files.length;i++){
            const f = files[i];
            const pre = await presign(f.name, f.type || 'application/octet-stream');
            await uploadToUrl(pre.url, f);
            bar.style.width = `${Math.round(((i+1)/files.length)*100)}%`;
          }
          setTimeout(()=> { progressEl.style.display='none'; bar.style.width='0%'; toast('تم رفع الملفات'); }, 350);
        } catch(err){ progressEl.style.display='none'; bar.style.width='0%'; toast('فشل الرفع: '+err.message); }
      }

      setupUploader('uploader','uploadProgress');
      setupUploader('caseUploader','uploadProgress');

      // AI analyze
      $('#runAi').addEventListener('click', async ()=>{
        const text = $('#facts').value.trim();
        if(!text) return toast('اكتب ملخص الوقائع أولاً');
        const resultEl = $('#aiResult'); const content = $('#analysisContent'); const spinner = $('#analysisSpinner');
        resultEl.style.display='block'; spinner.style.display='inline-block';
        try {
          const res = await fetch('/api/ai/analyze', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ text })});
          if(!res.ok) throw new Error('AI unavailable');
          const json = await res.json();
          spinner.style.display='none';
          if(json.raw) content.innerText = json.raw;
          else if(json.verdict) content.innerHTML = `<strong>${json.verdict}</strong><ul style="margin:8px 0 0 0;padding-inline-start:18px">${(json.issues||[]).map(i=>`<li>${i}</li>`).join('')}</ul><div style="margin-top:8px"><strong>توصيات:</strong><ol style="margin:6px 0 0 0;padding-inline-start:18px">${(json.recommendations||[]).map(r=>`<li>${r}</li>`).join('')}</ol></div>`;
          else content.innerText = JSON.stringify(json, null, 2);
        } catch(err){
          spinner.style.display='none';
          // fallback: local simulated analysis
          content.innerHTML = `<strong>تقرير تجريبي</strong><ul style="padding-inline-start:18px"><li>احتمالية نقص وثائق</li><li>توافق التواريخ بحاجة لمراجعة</li></ul><div style="margin-top:8px"><strong>توصيات:</strong><ol style="padding-inline-start:18px"><li>إرفاق إيصال تبليغ</li><li>رفع تفويض موقع</li></ol></div>`;
          toast('يتم استخدام وضع تجريبي للتحليل (خارج الشبكة)');
        }
      });

      // CASES: create & render
      function renderCases(){
        const ul = $('#casesList'); ul.innerHTML = store.cases.map(c => `<li><strong>${c.plaintiff}</strong> — ${c.subject} <div class="muted" style="font-size:13px">${new Date(c.createdAt).toLocaleString()} — <small>${c.id}</small></div></li>`).join('') || '<li class="muted">لا توجد قضايا بعد</li>';
      }
      $('#submitCase').addEventListener('click', async ()=>{
        const plaintiff = $('#plaintiff').value.trim(), subject = $('#caseSubject').value.trim(), details = $('#caseDetails').value.trim();
        if(!plaintiff || !subject || !details) return toast('اكمل الحقول المطلوبة');
        const id = 'case-' + Date.now();
        const newCase = { id, plaintiff, subject, details, createdAt: new Date().toISOString(), attachments: [] };
        // try backend
        try {
          const res = await fetch('/api/cases', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(newCase) });
          if(!res.ok) throw new Error('backend failed');
          const saved = await res.json();
          store.cases.unshift(saved);
        } catch(e){
          store.cases.unshift(newCase); // local fallback
          toast('تم الحفظ محلياً (وضع الشبكة غير متاح)', 2600);
        }
        saveStore(); renderCases();
        $('#caseForm').reset();
      });
      renderCases();

      // MEMOS
      async function loadMemos(){
        try {
          const res = await fetch('/api/memos');
          if(!res.ok) throw new Error('no backend');
          const list = await res.json();
          store.memos = list;
        } catch(e){
          // keep local memos
        }
        renderMemos();
      }
      function renderMemos(){ $('#memoList').innerHTML = store.memos.map(m => `<li><strong>${m.from||'مستخدم'}</strong> — ${m.time? new Date(m.time).toLocaleString():''}<div class="muted" style="font-size:13px;margin-top:6px">${m.text}</div></li>`).join('') || '<li class="muted">لا توجد مذكرات</li>'; }
      $('#sendMemo').addEventListener('click', async ()=>{
        const text = $('#memoText').value.trim(); if(!text) return toast('اكتب نص المذكرة');
        const memo = { id:'memo-'+Date.now(), from:'أنت', text, time: new Date().toISOString() };
        try {
          const res = await fetch('/api/memos', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(memo) });
          if(!res.ok) throw new Error('save failed');
          const saved = await res.json(); store.memos.unshift(saved);
        } catch(e){
          store.memos.unshift(memo); toast('حفظ محلي — الشبكة غير متاحة');
        }
        saveStore(); renderMemos(); $('#memoText').value='';
      });
      loadMemos();

      // SESSIONS
      $('#createSession').addEventListener('click', async ()=>{
        const subj = $('#sessionSubj').value.trim(), datetime = $('#sessionDate').value;
        if(!subj || !datetime) return toast('ادخل الموضوع والتاريخ');
        const session = { id:'s-'+Date.now(), subj, datetime, link: 'https://meet.example/' + Math.random().toString(36).slice(2,9) };
        try {
          const res = await fetch('/api/sessions', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(session) });
          if(!res.ok) throw new Error('backend fail');
          const saved = await res.json(); store.sessions.unshift(saved);
        } catch(e){
          store.sessions.unshift(session); toast('تم إنشاء الجلسة محلياً');
        }
        saveStore(); renderSessions();
        $('#sessionSubj').value=''; $('#sessionDate').value='';
      });
      function renderSessions(){ $('#sessionList').innerHTML = store.sessions.map(s => `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"><strong>${s.subj}</strong><div class="muted">${new Date(s.datetime).toLocaleString()}</div><a href="${s.link}" target="_blank">${s.link}</a></div>`).join('') || '<div class="muted">لا توجد جلسات</div>'; }
      renderSessions();

      // JUDGE board
      (function initJudge(){
        const ctx = document.getElementById('judgeChart');
        if(ctx) new Chart(ctx, { type:'doughnut', data:{ labels:['منجز','قيد','نواقص'], datasets:[{ data:[1420,85,12], backgroundColor:['#FFB703','#0fb06b','#ff6b6b'] }] }, options:{plugins:{legend:{position:'bottom'}}} });
        $('#judgeCases').textContent = store.cases.length ? (store.cases.slice(0,5).map(c=>c.subject).join(' · ')) : 'لا توجد قضايا للعرض';
      })();

      // Accessibility TTS & STT
      $('#enableTTS').addEventListener('click', ()=> {
        const text = $('#analysisContent').innerText || 'لا توجد نتائج';
        if('speechSynthesis' in window){ const u = new SpeechSynthesisUtterance(text); u.lang='ar-SA'; speechSynthesis.speak(u); toast('تشغيل القراءة'); } else toast('TTS غير متاح');
      });
      $('#startSTT').addEventListener('click', ()=> {
        if(!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) return toast('STT غير مدعوم في المتصفح'); const SR = window.SpeechRecognition || window.webkitSpeechRecognition; const r = new SR(); r.lang='ar-SA'; r.interimResults=true; r.onresult = e => { $('#facts').value = Array.from(e.results).map(r=>r[0].transcript).join(''); }; r.onerror = ()=> toast('فشل التعرف'); r.start();
      });

      // theme toggle (simple)
      $('#themeToggle').addEventListener('click', ()=> { document.body.classList.toggle('dark'); toast('تبديل السمة'); });

      // expose openPanel globally for quick-buttons
      window.openPanel = openPanel;
      window.showToast = toast;
    })();

    /* utility selector */
    function $(s, r=document) { return r.querySelector(s); }
    function $$(s, r=document) { return Array.from(r.querySelectorAll(s)); }
  </script>
</body>
</html>
