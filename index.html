<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>رواق العدل — المظهر المحترف</title>

  <!-- خطوط -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <meta name="description" content="واجهة احترافية لمنصة المساعد الذكي وإدارة القضايا — رواق العدل" />
  <meta name="author" content="روان الصبحي" />

  <style>
    /* ---------------- Design tokens ---------------- */
    :root{
      --bg-1:#022d2c; --bg-2:#063733;
      --card:#062e2b;
      --muted:#9bb6aa;
      --accent:#0fb06b;
      --gold:#FFB703;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      --shadow: 0 18px 48px rgba(0,0,0,0.6);
      --surface: rgba(255,255,255,0.02);
      --maxw:1200px;
      --ui-ease:cubic-bezier(.2,.9,.2,1);
      --focus: 3px solid rgba(15,176,107,0.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Cairo',sans-serif;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#e9fff2;-webkit-font-smoothing:antialiased}
    a{color:var(--accent);text-decoration:none}

    /* ---------------- Layout ---------------- */
    .app{max-width:var(--maxw);margin:20px auto;padding:16px;display:grid;grid-template-columns:320px 1fr;gap:18px;align-items:start}
    @media(max-width:980px){ .app{grid-template-columns:1fr;padding:12px} }

    /* background canvas */
    #bgCanvas{position:fixed;inset:0;z-index:-3;display:block}
    .bg-overlay{position:fixed;inset:0;z-index:-2;pointer-events:none;background:
      radial-gradient(800px 260px at 8% 12%, rgba(180,240,210,0.04), transparent 8%),
      radial-gradient(600px 220px at 92% 88%, rgba(120,200,170,0.03), transparent 8%),
      linear-gradient(180deg, rgba(0,0,0,0.16), rgba(0,0,0,0.34));mix-blend-mode:multiply}

    /* ---------------- Sidebar ---------------- */
    .sidebar{background:var(--card);border-radius:var(--radius);padding:14px;border:1px solid rgba(255,255,255,0.04);box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:58px;height:58px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#0b7d56);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(0,0,0,0.45)}
    .brand h1{margin:0;font-size:18px;color:#f8fff9}
    .brand p{margin:0;color:var(--muted);font-size:13px}

    nav.menu{margin-top:14px;display:flex;flex-direction:column;gap:8px}
    .menu button{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border:0;background:transparent;color:var(--muted);cursor:pointer;font-weight:700;text-align:right}
    .menu button.active{background:linear-gradient(90deg, rgba(15,176,107,0.06), rgba(255,255,255,0.02));border-left:4px solid var(--gold);color:#f8fff9}

    .assistant-list{margin-top:12px;border-radius:10px;overflow:auto;max-height:260px;padding:6px;background:var(--surface);border:1px solid rgba(255,255,255,0.02)}
    .assistant-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .assistant-item:last-child{border-bottom:0}
    .assistant-item button{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:6px;border-radius:8px;cursor:pointer}

    /* ---------------- Main ---------------- */
    .main{display:flex;flex-direction:column;gap:14px}
    .card{border-radius:12px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow)}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .search{flex:1;display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .search input{border:0;background:transparent;outline:none;color:#eaffef}

    /* ---------------- Form elements ---------------- */
    label{display:block;color:#eaf7ef;font-weight:700;margin-bottom:6px}
    input[type="text"], textarea, select, .file-drop{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.14);color:#eaffef;outline:none;font-size:14px}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center}
    .col{flex:1}
    .help{font-size:13px;color:rgba(255,255,255,0.7)}

    .mode-btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}
    .mode-btn.active{background:rgba(255,255,255,0.02);color:#eaffef;border-color:rgba(255,255,255,0.06)}

    .progress{height:8px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;margin-top:8px}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--gold));width:0%;transition:width .28s var(--ui-ease)}

    .btn{display:inline-flex;gap:8px;align-items:center;background:linear-gradient(180deg,var(--gold),#d59b03);color:#071018;border:0;padding:10px 12px;border-radius:10px;font-weight:800;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:700}
    .mini{font-size:13px;padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);cursor:pointer}

    pre.result{white-space:pre-wrap;background:rgba(0,0,0,0.16);padding:14px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);color:#eaffef}

    .form-grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
    @media(max-width:1000px){ .form-grid{grid-template-columns:1fr} }

    .file-drop{display:flex;align-items:center;justify-content:center;min-height:86px;cursor:pointer;border-radius:10px}

    /* drawer */
    .drawer{position:fixed;top:70px;right:20px;width:420px;max-width:calc(100% - 40px);height:calc(100% - 120px);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:16px;box-shadow:0 30px 80px rgba(0,0,0,0.75);z-index:1400;overflow:auto;transform:translateY(8px);opacity:0;pointer-events:none;transition:all .28s var(--ui-ease)}
    .drawer.show{transform:translateY(0);opacity:1;pointer-events:auto}
    .attachment{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--muted)}

    /* focus */
    :focus{outline:var(--focus);outline-offset:3px}

    /* small */
    .muted-sm{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <canvas id="bgCanvas" aria-hidden="true"></canvas>
  <div class="bg-overlay" aria-hidden="true"></div>

  <div class="app" role="application" aria-label="رواق العدل — المنصة">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="الشريط الجانبي">
      <div class="brand" role="img" aria-label="شعار رواق العدل">
        <div class="logo"><i class="fa-solid fa-balance-scale" style="color:#fff;font-size:20px"></i></div>
        <div>
          <h1>رواق العدل</h1>
          <p class="muted">مركز القضايا والمساعد</p>
        </div>
      </div>

      <nav class="menu" aria-label="التنقل">
        <button class="active" data-panel="panel-assistant"><i class="fa-solid fa-brain"></i> المساعد الذكي</button>
        <button data-panel="panel-casefile"><i class="fa-solid fa-file-circle-plus"></i> قيد دعوى</button>
        <button data-panel="panel-judgeboard"><i class="fa-solid fa-gavel"></i> منصة القاضي</button>
        <button data-panel="panel-memo"><i class="fa-solid fa-file-lines"></i> تبادل مذكرات</button>
        <button data-panel="panel-sessions"><i class="fa-solid fa-video"></i> جلسات رقمية</button>
        <button data-panel="panel-accessibility"><i class="fa-solid fa-universal-access"></i> الوصول</button>
        <button data-panel="panel-security"><i class="fa-solid fa-shield"></i> الأمن</button>
      </nav>

      <div style="margin-top:14px">
        <strong>قائمة المساعدين</strong>
        <div class="assistant-list" id="assistantList" tabindex="0" aria-label="قائمة المساعدين"></div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="addAssistant" class="mini">+ جديد</button>
          <button id="manageAssistants" class="mini">إدارة</button>
        </div>
      </div>

      <div style="margin-top:14px;text-align:center" class="muted">licensing@rawan.dev</div>
    </aside>

    <!-- Main -->
    <main class="main" id="mainContent">
      <div class="topbar card" role="region" aria-label="شريط الأدوات">
        <div class="search" role="search">
          <i class="fa-solid fa-magnifying-glass" style="color:var(--muted)"></i>
          <input id="unifiedSearch" placeholder="بحث: رقم قضية، اسم، قرار..." aria-label="بحث القضايا">
        </div>
        <div class="controls" style="display:flex;gap:8px;align-items:center">
          <button id="themeToggle" class="mini" aria-pressed="false" title="تبديل السمة">سمة</button>
          <button id="openJudgeDrawer" class="mini" title="فتح تجربة قضية">قاضي — تجربة</button>
        </div>
      </div>

      <!-- Assistant -->
      <section id="panel-assistant" class="card" role="region" aria-labelledby="assistantTitle">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 id="assistantTitle">المساعد الذكي المتفاعل</h2>
          <div class="row" style="align-items:center">
            <label for="assistantSelect" class="help" style="margin-left:10px">الشخصية</label>
            <select id="assistantSelect" aria-label="اختيار شخصية المساعد" style="min-width:220px"></select>
          </div>
        </div>

        <div class="assistant-controls" style="margin-top:12px;display:flex;gap:12px">
          <div class="col">
            <label for="facts">ملخص الوقائع أو النص</label>
            <textarea id="facts" placeholder="ألصق نص الدعوى أو اكتب ملخصًا..." aria-label="ملخص الوقائع"></textarea>

            <div class="row" style="margin-top:8px;justify-content:space-between">
              <div class="modes" role="tablist" aria-label="وضع المساعد">
                <button class="mode-btn active" data-mode="concise" aria-pressed="true">مختصر</button>
                <button class="mode-btn" data-mode="detailed" aria-pressed="false">مفصّل</button>
                <button class="mode-btn" data-mode="step" aria-pressed="false">خطوات</button>
              </div>
              <div class="help muted-sm">اختصار: Ctrl/Cmd + Enter</div>
            </div>

            <div class="progress" id="progressBar" aria-hidden="true"><i></i></div>
          </div>

          <div style="width:220px;display:flex;flex-direction:column;gap:8px">
            <button id="runBtn" class="btn" aria-live="polite" aria-busy="false"><i class="fa-solid fa-rocket"></i> تشغيل التحليل</button>
            <button id="streamToggle" class="btn ghost" aria-pressed="false">بث لحظي</button>
            <button id="saveDraftBtn" class="btn ghost">حفظ مسودة</button>
            <div style="display:flex;gap:8px;margin-top:6px">
              <button id="exportTxt" class="mini">تصدير</button>
              <button id="printBtn" class="mini">طباعة</button>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:14px;align-items:flex-start">
          <div style="flex:1">
            <h3>نتيجة التحليل</h3>
            <pre id="analysisResult" class="result" aria-live="polite">لم يتم تشغيل أي تحليل بعد.</pre>
          </div>

          <aside style="width:320px">
            <div class="card">
              <h4>تفاصيل المساعد</h4>
              <div id="assistantDetails" class="muted-sm" style="margin-top:8px">اختر شخصية لعرض النص النظامي</div>
            </div>

            <div class="card" style="margin-top:12px">
              <h4>سجل التحليلات</h4>
              <div id="historyList" style="max-height:220px;overflow:auto"></div>
            </div>
          </aside>
        </div>
      </section>

      <!-- Case filing -->
      <section id="panel-casefile" class="card" role="region" hidden>
        <h2 style="margin-top:0">قيد دعوى — نموذج جديد</h2>
        <p class="muted">املأ الحقول الأساسية ثم اضغط "قيد الدعوى". النظام يتحقق من الحقول المطلوبة ويتيح حفظًا محليًا إذا انقطع الاتصال.</p>

        <form id="caseForm" class="form-grid" onsubmit="return false" novalidate>
          <div>
            <div style="display:flex;gap:12px">
              <div style="flex:1">
                <label for="case_id">رقم القضية (اختياري)</label>
                <input id="case_id" type="text" placeholder="مثال: C-2026-012" />
              </div>
              <div style="width:180px">
                <label for="case_internal">الرقم الداخلي</label>
                <input id="case_internal" type="text" placeholder="رقم داخلي" />
              </div>
            </div>

            <div style="margin-top:12px">
              <label for="case_plaintiff">اسم المدعي</label>
              <input id="case_plaintiff" type="text" required placeholder="اسم المدعي" />
              <div id="err_plaintiff" class="muted-sm" style="display:none;color:#ffcccc"></div>
            </div>

            <div style="margin-top:12px">
              <label for="case_subject">موضوع الدعوى</label>
              <input id="case_subject" type="text" required placeholder="موضوع الدعوى" />
              <div id="err_subject" class="muted-sm" style="display:none;color:#ffcccc"></div>
            </div>

            <div style="margin-top:12px">
              <label for="case_details">تفاصيل/ملخص</label>
              <textarea id="case_details" placeholder="تفاصيل الدعوى..." required></textarea>
            </div>

            <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
              <div style="flex:1">
                <label>مرفقات</label>
                <div id="caseUploader" class="file-drop" tabindex="0" aria-label="مساحة رفع الملفات">اسحب الملفات هنا أو اضغط للاختيار (PDF، صور)</div>
                <div id="caseUploadProgress" class="progress" style="display:none"><i></i></div>
              </div>
              <div style="width:160px">
                <label>&nbsp;</label>
                <button id="submitCase" class="btn" type="button">قيد الدعوى</button>
              </div>
            </div>

            <div id="caseFeedback" class="muted-sm" style="margin-top:10px;display:none"></div>
          </div>

          <aside>
            <div class="card">
              <h4>إعدادات</h4>
              <div style="margin-top:8px">
                <label for="case_priority">الأولوية</label>
                <select id="case_priority">
                  <option value="normal">عادية</option>
                  <option value="review">مراجعة</option>
                  <option value="urgent">عاجلة</option>
                </select>
              </div>

              <div style="margin-top:8px">
                <label for="case_status">الحالة</label>
                <select id="case_status">
                  <option value="open">مفتوحة</option>
                  <option value="review">قيد المراجعة</option>
                  <option value="deferred">مؤجلة</option>
                </select>
              </div>

              <div style="margin-top:8px">
                <label for="case_assigned">القاضي المعيّن (اختياري)</label>
                <input id="case_assigned" type="text" placeholder="اسم القاضي" />
              </div>

              <div style="margin-top:10px">
                <h5 class="muted-sm">ملاحظة</h5>
                <p class="muted-sm">بعد القيد ستظهر الدعوى في لوحة القاضي حيث يمكن التعديل وإصدار الأوامر.</p>
              </div>
            </div>
          </aside>
        </form>
      </section>

      <!-- Judge board (simplified) -->
      <section id="panel-judgeboard" class="card" role="region" hidden>
        <h2 style="margin-top:0">منصة القاضي — إدارة القضايا</h2>
        <p class="muted">قائمة سريعة للقضايا — اضغط "عرض" لفتح تفاصيل القضية وتحريرها.</p>
        <div class="card" style="margin-top:12px">
          <div id="judgeCaseList" class="case-list" aria-live="polite"></div>
        </div>
      </section>

      <!-- other placeholders -->
      <section id="panel-memo" class="card" hidden><h2>تبادل مذكرات</h2><p class="muted">صندوق وارد/صادر مع توقيع PKI (قيد الربط)</p></section>
      <section id="panel-sessions" class="card" hidden><h2>جلسات رقمية</h2><p class="muted">روابط مؤمنة، تفريغ صوتي</p></section>
      <section id="panel-accessibility" class="card" hidden><h2>الوصول</h2><p class="muted">TTS / STT / Live captions</p></section>
      <section id="panel-security" class="card" hidden><h2>الأمن</h2><p class="muted">PKI، SSO، سجلات تدقيق</p></section>
    </main>
  </div>

  <!-- Drawer: judge detail -->
  <aside id="judgeDrawer" class="drawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="drawerTitle" style="margin:0">تفاصيل القضية</h3>
      <div style="display:flex;gap:8px">
        <button id="closeDrawer" class="mini">إغلاق</button>
      </div>
    </div>

    <div style="margin-top:10px">
      <label>رقم القضية</label>
      <div id="f_caseid" style="font-weight:800;color:var(--muted)"></div>
    </div>

    <div style="margin-top:10px">
      <label for="f_internal">الرقم الداخلي</label>
      <input id="f_internal" type="text" />
    </div>

    <div style="margin-top:10px">
      <label for="f_plaintiff">اسم المدعي</label>
      <input id="f_plaintiff" type="text" />
    </div>

    <div style="margin-top:10px">
      <label for="f_subject">موضوع الدعوى</label>
      <input id="f_subject" type="text" />
    </div>

    <div style="margin-top:10px">
      <label for="f_created">تاريخ الإنشاء</label>
      <div id="f_created" class="muted-sm"></div>
    </div>

    <div style="margin-top:10px">
      <label for="f_priority">الأولوية</label>
      <select id="f_priority"><option value="urgent">عاجلة</option><option value="review">مراجعة</option><option value="normal">عادية</option></select>
    </div>

    <div style="margin-top:10px">
      <label for="f_status">الحالة</label>
      <select id="f_status"><option value="open">مفتوحة</option><option value="review">قيد المراجعة</option><option value="completed">منجزة</option><option value="deferred">مؤجلة</option></select>
    </div>

    <div style="margin-top:10px">
      <label for="f_assigned">القاضي المعيّن</label>
      <input id="f_assigned" type="text" />
    </div>

    <div style="margin-top:10px">
      <label for="f_notes">ملاحظات / ملخص</label>
      <textarea id="f_notes"></textarea>
    </div>

    <div style="margin-top:10px">
      <label>المرفقات</label>
      <div id="f_attachments" class="attachments"></div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="f_save" class="btn">حفظ</button>
      <button id="f_assign" class="mini">تعيين</button>
      <button id="f_issue" class="mini">إصدار أمر</button>
      <button id="f_request_ai" class="mini">طلب اقتراح AI</button>
      <button id="f_print" class="mini">طباعة</button>
    </div>

    <div style="margin-top:12px" class="audit"><strong>سجل مختصر:</strong><div id="f_audit_list" class="muted-sm" style="margin-top:8px"></div></div>
  </aside>

  <div id="toastWrap" aria-live="polite" style="position:fixed;left:50%;transform:translateX(-50%);top:18px;z-index:2000"></div>

  <script>
    /* ---------------- Background animation (refined for professional look) ---------------- */
    (function(){
      const canvas = document.getElementById('bgCanvas'), ctx = canvas.getContext('2d', {alpha:true});
      let DPR = Math.max(1, window.devicePixelRatio || 1), W = innerWidth, H = innerHeight;
      function resize(){ DPR = Math.max(1, window.devicePixelRatio || 1); W = canvas.width = Math.floor(innerWidth * DPR); H = canvas.height = Math.floor(innerHeight * DPR); canvas.style.width = innerWidth + 'px'; canvas.style.height = innerHeight + 'px'; ctx.setTransform(DPR,0,0,DPR,0,0); }
      addEventListener('resize', resize); resize();

      // lightweight particles + circuit traces + binary glyphs
      const particles = []; const circuits = []; const glyphs = [];
      function init(){
        particles.length = circuits.length = glyphs.length = 0;
        const pcount = Math.max(30, Math.floor(innerWidth / 30));
        for(let i=0;i<pcount;i++) particles.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,r:Math.random()*1.4+0.4,vx:(Math.random()-0.5)*0.2,vy:(Math.random()-0.5)*0.2,a:0.06+Math.random()*0.22});
        const cols = 20;
        for(let i=0;i<cols;i++) circuits.push({baseX:(i/cols)*innerWidth + (Math.random()*60-30),angle:i%2?1:-1,segments:6+Math.floor(Math.random()*6),segLen:(innerHeight+200)/10,thickness:0.6+Math.random()*1.2});
        const gcount = Math.max(8, Math.floor(innerWidth/120));
        for(let i=0;i<gcount;i++) glyphs.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,v:0.2+Math.random()*0.5,char:Math.random()>0.5?'0':'1',a:0.04+Math.random()*0.14});
      }
      init();

      let t = performance.now();
      function frame(now){
        const dt = (now - t)/1000; t = now;
        ctx.fillStyle = 'rgba(2,20,18,0.12)'; ctx.fillRect(0,0,innerWidth,innerHeight);

        // circuits
        ctx.save(); ctx.lineCap = 'round';
        circuits.forEach((c, idx) => {
          ctx.beginPath();
          let x = c.baseX + Math.sin(now*0.0004 + idx)*12;
          let y = -40;
          ctx.moveTo(x,y);
          for(let s=0;s<c.segments;s++){
            x += c.angle * (12 + Math.sin(now*0.0006 + s)*6) + Math.cos(s*0.95 + idx)*4;
            y += c.segLen - (s*2);
            ctx.lineTo(x, y);
          }
          ctx.strokeStyle = 'rgba(90,170,150,0.12)';
          ctx.lineWidth = c.thickness;
          ctx.stroke();
        });
        ctx.restore();

        // particles
        particles.forEach(p=>{
          p.x += p.vx; p.y += p.vy;
          if(p.x < -20) p.x = innerWidth + 20;
          if(p.x > innerWidth + 20) p.x = -20;
          if(p.y < -20) p.y = innerHeight + 20;
          if(p.y > innerHeight + 20) p.y = -20;
          const g = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*8);
          g.addColorStop(0, `rgba(140,240,200,${p.a})`);
          g.addColorStop(1, 'rgba(140,240,200,0)');
          ctx.fillStyle = g;
          ctx.beginPath(); ctx.arc(p.x,p.y,p.r*5,0,Math.PI*2); ctx.fill();
        });

        // glyphs
        ctx.save(); ctx.font = '10px Cairo, monospace';
        glyphs.forEach(g=>{
          g.y += g.v * dt * 60;
          if(g.y > innerHeight + 20){ g.y = -20; g.x = Math.random()*innerWidth; g.char = Math.random()>0.5?'0':'1'; }
          ctx.globalAlpha = g.a;
          ctx.fillStyle = 'rgba(170,230,200,0.08)';
          ctx.fillText(g.char, g.x, g.y);
        });
        ctx.restore();

        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
      window._initBg = init;
    })();

    /* ---------------- Helper utilities ---------------- */
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    function showToast(msg, ttl=2200){
      const wrap = document.getElementById('toastWrap');
      const el = document.createElement('div'); el.textContent = msg;
      el.style.cssText = 'background:rgba(0,0,0,0.75);color:#fff;padding:8px 12px;border-radius:8px;margin-top:6px;display:inline-block';
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity = '0'; setTimeout(()=>el.remove(), 300); }, ttl);
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /* ---------------- Core UI & data ---------------- */
    (function(){
      // Assistants store & UI
      const AS_KEY = 'rwaq_assistants_rrrawan764-cloud';
      let assistants = [];
      function defaultAssistants(){ return [
        {id:'legal_expert', name:'الخبير القانوني', system:'أنت خبير قانوني. راجع النواقص وقدم توصيات عملية.'},
        {id:'tech_auditor', name:'المدقق التقني', system:'أنت مدقق تقني: تحقَّق من سلامة المستندات والتواقيع.'}
      ]; }
      function loadAssistants(){ try{ assistants = JSON.parse(localStorage.getItem(AS_KEY)) || defaultAssistants(); }catch(e){ assistants = defaultAssistants(); } renderAssistants(); }
      function saveAssistants(){ localStorage.setItem(AS_KEY, JSON.stringify(assistants)); }

      function renderAssistants(){
        const list = $('#assistantList'); list.innerHTML = '';
        assistants.forEach(a=>{
          const row = document.createElement('div'); row.className = 'assistant-item';
          row.innerHTML = `<div><div class="assistant-name">${escapeHtml(a.name)}</div><div class="meta">${escapeHtml(a.system.slice(0,80))}${a.system.length>80?'...':''}</div></div>
            <div style="display:flex;gap:6px"><button class="mini" data-id="${a.id}" data-action="select">اختيار</button><button class="mini" data-id="${a.id}" data-action="edit">تعديل</button><button class="mini" data-id="${a.id}" data-action="delete">حذف</button></div>`;
          list.appendChild(row);
        });
        const sel = $('#assistantSelect'); sel.innerHTML = assistants.map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('');
        if(!sel.value && assistants.length) sel.value = assistants[0].id;
        renderAssistantDetails(currentAssistant());
      }
      function currentAssistant(){ const v = $('#assistantSelect').value; return assistants.find(a=>a.id===v) || assistants[0]; }
      function renderAssistantDetails(a){ $('#assistantDetails').innerHTML = a ? `<strong>${escapeHtml(a.name)}</strong><div class="muted-sm" style="margin-top:6px">${escapeHtml(a.system)}</div>` : 'لا يوجد مساعد محدد'; }

      // assistant list events
      $('#assistantList').addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const id = btn.dataset.id, action = btn.dataset.action;
        const idx = assistants.findIndex(x=>x.id===id);
        if(action === 'select'){ $('#assistantSelect').value = id; renderAssistantDetails(assistants[idx]); showToast('تم اختيار المساعد'); }
        if(action === 'edit'){ const a = assistants[idx]; const name = prompt('تعديل اسم المساعد:', a.name); if(!name) return; const system = prompt('نص النظام:', a.system); a.name = name; a.system = system||a.system; saveAssistants(); renderAssistants(); showToast('تم التعديل'); }
        if(action === 'delete'){ if(confirm('حذف المساعد نهائياً؟')){ assistants.splice(idx,1); saveAssistants(); renderAssistants(); showToast('تم الحذف'); } }
      });
      $('#addAssistant').addEventListener('click', ()=>{ const name = prompt('اسم المساعد:'); if(!name) return; const system = prompt('نص النظام:', 'أنت مساعد قانوني.'); const id = name.toLowerCase().replace(/\s+/g,'_') + '_' + Date.now().toString(36); assistants.unshift({id,name,system}); saveAssistants(); renderAssistants(); showToast('تم الإضافة'); });

      // modes
      $$('.mode-btn').forEach(b => b.addEventListener('click', ()=> { $$('.mode-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); }));

      // run analysis (with progressive reveal and fallback)
      $('#runBtn').addEventListener('click', async ()=>{
        const text = $('#facts').value.trim();
        if(!text){ showToast('أدخل ملخص الوقائع'); return; }
        const assistant = currentAssistant();
        const mode = (document.querySelector('.mode-btn.active')||{}).dataset.mode || 'concise';
        toggleRun(true);
        $('#analysisResult').textContent = '';
        try{
          const res = await fetch('/api/ai/analyze', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text, assistant, mode }) });
          if(!res.ok) throw new Error('no-ai');
          const json = await res.json();
          const out = json.raw || (json.verdict ? json.verdict + '\n\n' + (json.recommendations||[]).map((r,i)=>`${i+1}. ${r}`).join('\n') : JSON.stringify(json));
          await progressiveReveal(out);
          showToast('انتهى التحليل');
        }catch(e){
          const sim = `تحليل (${assistant.name}) — ${mode}\n\n• نقاط محتملة:\n- غياب إثبات التبليغ\n- نقص التفويض\n\nتوصيات:\n1. إرفاق إيصالات\n2. الحصول على تفويض موقع`;
          await progressiveReveal(sim);
          showToast('تم التحليل محليًا');
        }finally{ toggleRun(false); }
      });

      function toggleRun(isRunning){
        $('#runBtn').disabled = isRunning;
        $('#runBtn').setAttribute('aria-busy', isRunning ? 'true' : 'false');
        $('#progressBar').style.display = isRunning ? 'block' : 'none';
        if(!isRunning) $('#progressBar i').style.width = '0%';
      }

      async function progressiveReveal(text){
        const el = $('#analysisResult'); el.textContent = '';
        const chars = Array.from(text);
        for(let i=0;i<chars.length;i++){
          el.textContent += chars[i];
          if(i % 12 === 0) $('#progressBar i').style.width = Math.min(98, Math.round((i/chars.length)*100)) + '%';
          await new Promise(r=>setTimeout(r, 8 + Math.random()*14));
        }
        $('#progressBar i').style.width = '100%';
      }

      // file uploader (simple UI, local simulation)
      function setupUploader(btnSel, progSel){
        const btn = $(btnSel), prog = $(progSel);
        btn.addEventListener('click', ()=> { const inp = document.createElement('input'); inp.type='file'; inp.multiple=true; inp.onchange = ()=> handleFiles(inp.files, prog); inp.click(); });
        ['dragenter','dragover'].forEach(ev=> btn.addEventListener(ev, e=> { e.preventDefault(); btn.style.borderColor = 'rgba(15,176,107,0.45)'; }));
        ['dragleave','drop'].forEach(ev=> btn.addEventListener(ev, e=> { e.preventDefault(); btn.style.borderColor=''; if(e.type==='drop') handleFiles(e.dataTransfer.files, prog); }));
      }
      async function handleFiles(files, progressEl){
        if(!files || files.length===0) return;
        progressEl.style.display = 'block';
        const bar = progressEl.querySelector('i'); bar.style.width = '0%';
        for(let i=0;i<files.length;i++){ await new Promise(r=>setTimeout(r, 220 + Math.random()*260)); bar.style.width = `${Math.round(((i+1)/files.length)*100)}%`; }
        setTimeout(()=>{ progressEl.style.display='none'; bar.style.width='0%'; showToast('تم رفع الملفات (محلياً)'); }, 300);
      }
      setupUploader('#caseUploader', '#caseUploadProgress');

      // submit case (validate + save locally or send)
      $('#submitCase').addEventListener('click', async ()=>{
        const plaintiff = $('#case_plaintiff').value.trim();
        const subject = $('#case_subject').value.trim();
        const details = $('#case_details').value.trim();
        $('#err_plaintiff').style.display = 'none'; $('#err_subject').style.display = 'none';
        if(!plaintiff){ $('#err_plaintiff').textContent = 'الاسم مطلوب'; $('#err_plaintiff').style.display = 'block'; return; }
        if(!subject){ $('#err_subject').textContent = 'الموضوع مطلوب'; $('#err_subject').style.display = 'block'; return; }

        $('#caseFeedback').style.display = 'block'; $('#caseFeedback').textContent = 'جاري قيد الدعوى...';
        const payload = {
          id: $('#case_id').value.trim() || 'C-' + Date.now().toString(36).toUpperCase(),
          internalId: $('#case_internal').value.trim(),
          plaintiff, subject, details,
          priority: $('#case_priority').value, status: $('#case_status').value, assigned: $('#case_assigned').value.trim(),
          created: new Date().toISOString(), attachments: [], audit:[{actor:'نظام',action:'قيد محلي',at:new Date().toISOString()}]
        };
        try{
          const res = await fetch('/api/cases', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if(!res.ok) throw new Error('server');
          const data = await res.json();
          $('#caseFeedback').textContent = 'تم القيد — مرجع: ' + (data.id||payload.id);
          showToast('تم قيد الدعوى عبر الخادم');
          saveCaseLocal(data);
        }catch(e){
          saveCaseLocal(payload);
          $('#caseFeedback').textContent = 'تم الحفظ محلياً (شبكة غير متاحة)';
          showToast('تم حفظ الدعوى محلياً');
        }
      });

      // local case store & render list
      const CASE_KEY = 'rwaq_cases_local';
      function saveCaseLocal(c){ const list = JSON.parse(localStorage.getItem(CASE_KEY)||'[]'); list.unshift(c); localStorage.setItem(CASE_KEY, JSON.stringify(list)); renderJudgeCaseList(); }
      function renderJudgeCaseList(){
        const list = JSON.parse(localStorage.getItem(CASE_KEY)||'[]');
        const el = $('#judgeCaseList'); el.innerHTML = '';
        if(!list || list.length === 0){ el.innerHTML = '<div class="muted">لا توجد قضايا محلية</div>'; return; }
        list.slice(0,50).forEach(c=>{
          const row = document.createElement('div'); row.className = 'case-item';
          row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems='center'; row.style.padding='10px'; row.style.borderBottom='1px dashed rgba(255,255,255,0.03)';
          row.innerHTML = `<div style="flex:1"><strong>${escapeHtml(c.plaintiff||'—')}</strong><div class="muted-sm">${escapeHtml(c.id||'—')} — ${escapeHtml(c.subject||'—')}</div></div>
            <div style="min-width:140px; text-align:left"><div class="muted-sm">${new Date(c.created||Date.now()).toLocaleDateString()}</div><div style="margin-top:8px"><button class="mini" data-id="${c.id}" data-action="open">عرض</button> <button class="mini" data-id="${c.id}" data-action="ai">AI</button></div></div>`;
          el.appendChild(row);
        });
      }

      // open judge drawer by id
      $('#judgeCaseList').addEventListener('click', e=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const id = btn.dataset.id, action = btn.dataset.action;
        const list = JSON.parse(localStorage.getItem(CASE_KEY) || '[]');
        const c = list.find(x=>x.id === id);
        if(!c) return;
        if(action === 'open') openJudgeDrawer(c);
        if(action === 'ai'){ openJudgeDrawer(c); setTimeout(()=> $('#f_request_ai').click(), 200); }
      });

      function openJudgeDrawer(c){
        const drawer = $('#judgeDrawer'); drawer.classList.add('show');
        $('#drawerTitle').textContent = `قضية — ${c.id || ''}`;
        $('#f_caseid').textContent = c.id || '';
        $('#f_internal').value = c.internalId || '';
        $('#f_plaintiff').value = c.plaintiff || '';
        $('#f_subject').value = c.subject || '';
        $('#f_created').textContent = new Date(c.created || Date.now()).toLocaleString();
        $('#f_priority').value = c.priority || 'normal';
        $('#f_status').value = c.status || 'open';
        $('#f_assigned').value = c.assigned || '';
        $('#f_notes').value = c.details || c.notes || '';
        const att = $('#f_attachments'); att.innerHTML = '';
        (c.attachments||[]).forEach(a=> { const node = document.createElement('div'); node.className='attachment'; node.innerHTML = `<div>${escapeHtml(a.name)}</div><div><a href="${a.url||'#'}" target="_blank" class="muted-sm">فتح</a></div>`; att.appendChild(node); });
        $('#f_audit_list').innerHTML = (c.audit||[]).map(it=>`${new Date(it.at).toLocaleString()} — ${escapeHtml(it.actor)}: ${escapeHtml(it.action)}`).join('<br>') || '<div class="muted-sm">لا سجلات</div>';
        drawer.dataset.caseId = c.id;
      }

      $('#closeDrawer').addEventListener('click', ()=> $('#judgeDrawer').classList.remove('show'));

      // drawer actions: save, request AI (with fallback)
      $('#f_save').addEventListener('click', ()=>{
        const id = $('#judgeDrawer').dataset.caseId;
        if(!id){ showToast('لا توجد قضية محددة'); return; }
        const list = JSON.parse(localStorage.getItem(CASE_KEY)||'[]');
        const idx = list.findIndex(x=>x.id === id);
        if(idx < 0){ showToast('القضية غير موجودة محلياً'); return; }
        list[idx].internalId = $('#f_internal').value.trim();
        list[idx].plaintiff = $('#f_plaintiff').value.trim();
        list[idx].subject = $('#f_subject').value.trim();
        list[idx].priority = $('#f_priority').value;
        list[idx].status = $('#f_status').value;
        list[idx].assigned = $('#f_assigned').value.trim();
        list[idx].notes = $('#f_notes').value.trim();
        list[idx].audit = list[idx].audit || []; list[idx].audit.unshift({actor:'مستخدم',action:'حفظ تعديلات',at:new Date().toISOString()});
        localStorage.setItem(CASE_KEY, JSON.stringify(list));
        renderJudgeCaseList(); showToast('تم حفظ التعديلات محلياً');
      });

      $('#f_request_ai').addEventListener('click', async ()=>{
        const id = $('#judgeDrawer').dataset.caseId; if(!id) return;
        const btn = $('#f_request_ai'); btn.disabled = true; btn.textContent = 'جاري الطلب...';
        try{
          const res = await fetch('/api/ai/analyze', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ caseId: id }) });
          if(!res.ok) throw new Error('no-ai');
          const json = await res.json(); const out = json.raw || json.verdict || 'لا نتيجة';
          $('#f_notes').value += '\n\n[اقتراح AI]\n' + out;
          showToast('أضيف اقتراح AI للملاحظات');
        }catch(e){
          $('#f_notes').value += '\n\n[اقتراح تجريبي]\nراجع إثبات التبليغ والتفويض.';
          showToast('فشل الطلب — عرض اقتراح تجريبي');
        }finally{ btn.disabled = false; btn.textContent = 'طلب اقتراح AI'; }
      });

      // history store and rendering
      const HIST_KEY = 'rwaq_history_rrrawan764-cloud';
      function addHistory(entry){ const hist = JSON.parse(localStorage.getItem(HIST_KEY)||'[]'); hist.unshift(entry); if(hist.length>80) hist.length = 80; localStorage.setItem(HIST_KEY, JSON.stringify(hist)); renderHistory(); }
      function renderHistory(){
        const list = JSON.parse(localStorage.getItem(HIST_KEY)||'[]'); const container = $('#historyList'); container.innerHTML = '';
        if(!list || list.length===0){ container.innerHTML = '<div class="muted">لا يوجد سجل</div>'; return; }
        list.slice(0,50).forEach(h=>{
          const node = document.createElement('div'); node.style.padding='8px'; node.style.borderBottom='1px dashed rgba(255,255,255,0.03)';
          node.innerHTML = `<strong>${escapeHtml(h.assistant)}</strong> <div class="muted-sm">${new Date(h.time).toLocaleString()}</div><div style="margin-top:8px"><button class="mini" data-time="${h.time}" data-a="view">عرض</button> <button class="mini" data-time="${h.time}" data-a="dl">تنزيل</button></div>`;
          container.appendChild(node);
        });
        container.querySelectorAll('button').forEach(b=> b.addEventListener('click', (e)=>{ const t=b.dataset.time, a=b.dataset.a; const list = JSON.parse(localStorage.getItem(HIST_KEY)||'[]'); const entry = list.find(x=>x.time===t); if(!entry) return; if(a==='view') $('#analysisResult').textContent = entry.output || '[لا مخرج]'; if(a==='dl') downloadText(entry.output||'', 'analysis-'+t+'.txt'); }));
      }

      function downloadText(content, filename){ const blob = new Blob([content||''], {type:'text/plain;charset=utf-8'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

      // Panel switching
      $$('.menu button').forEach(btn => btn.addEventListener('click', ()=>{
        $$('.menu button').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        const mapping = { 'panel-assistant':'panel-assistant','panel-casefile':'panel-casefile','panel-judgeboard':'panel-judgeboard','panel-memo':'panel-memo','panel-sessions':'panel-sessions','panel-accessibility':'panel-accessibility','panel-security':'panel-security' };
        Object.values(mapping).forEach(id => { const el = document.getElementById(id); if(el) el.hidden = true; });
        const id = btn.dataset.panel; const panel = document.getElementById(id); if(panel) panel.hidden = false;
        window.scrollTo({top:0,behavior:'smooth'});
      }));

      // keyboard shortcut
      window.addEventListener('keydown', e=> { if((e.ctrlKey||e.metaKey) && e.key==='Enter') $('#runBtn').click(); });

      // helper demo open drawer
      $('#openJudgeDrawer').addEventListener('click', ()=> {
        const cases = JSON.parse(localStorage.getItem(CASE_KEY)||'[]');
        if(cases && cases[0]) openJudgeDrawer(cases[0]); else showToast('لا توجد قضايا محلية — أنشئ قيداً أولاً');
      });

      // init
      function init(){ loadAssistants(); renderHistory(); renderJudgeCaseList(); }
      init();
    })();
  </script>
</body>
</html>
